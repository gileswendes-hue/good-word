<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GOOD WORD / BAD WORD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- CORE STYLES --- */
        body { 
            font-family: 'Inter', sans-serif; 
            overscroll-behavior-y: none;
            overflow-x: hidden; 
            width: 100%;
        }

        .card { 
            backdrop-filter: blur(10px); 
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            position: relative; 
            z-index: 10;
            touch-action: pan-y; 
        }
        
        /* Base button styles */
        .good-button { background: linear-gradient(145deg, #10b981, #059669); }
        .bad-button { background: linear-gradient(145deg, #ef4444, #dc2626); }
        .not-word-button { background: linear-gradient(145deg, #64748b, #475569); }
        button { transition: transform 0.1s ease, box-shadow 0.1s ease; }
        button:active { transform: scale(0.98); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
        
        .version-indicator { position: fixed; bottom: 5px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; color: #9ca3af; z-index: 50; }
        
        @media (max-width: 640px) { .rank-item { font-size: 0.8rem; } .vote-counts { font-size: 0.875rem; } }

        /* --- ANIMATION CLASSES --- */
        .animate-fly-left { animation: fly-out-left 0.6s ease-out forwards; }
        .animate-fly-right { animation: fly-out-right 0.6s ease-out forwards; }

        @keyframes fly-out-left { 
            0% { transform: translate(0, 0) rotate(0deg); opacity: 1; } 
            100% { transform: translate(-150vw, 0) rotate(-25deg); opacity: 0; } 
        }
        @keyframes fly-out-right { 
            0% { transform: translate(0, 0) rotate(0deg); opacity: 1; } 
            100% { transform: translate(150vw, 0) rotate(25deg); opacity: 0; } 
        }

        .word-reset { transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.2s, opacity 0.2s !important; }
        .color-fade { transition: color 0.1s ease-out !important; }

        .word-fade-llama { transition: opacity 8s ease-out, transform 8s ease-out; opacity: 0 !important; transform: scale(0.9) !important; }
        .word-fade-quick { transition: opacity 0.3s ease-out, transform 0.3s ease-out; opacity: 0 !important; transform: scale(0.95) !important; }

        #wordDisplay { 
            font-size: 6rem; white-space: nowrap; overflow: hidden; max-width: 100%; box-sizing: border-box; 
            position: relative; z-index: 20; touch-action: none; user-select: none; 
            will-change: transform, opacity, color; 
        }
        
        /* --- THEME STYLES --- */
        
        /* DEFAULT */
        body.theme-default { background: linear-gradient(135deg, #fef2be 0%, #b5def0 100%) !important; }
        .theme-default #gameCard { backdrop-filter: blur(10px); background-color: rgba(255, 255, 255, 0.95); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); border: 1px solid rgba(0, 0, 0, 0.05); }
        
        @keyframes rainbow-text { 0% { -webkit-filter: hue-rotate(0deg); filter: hue-rotate(0deg); } 100% { -webkit-filter: hue-rotate(360deg); filter: hue-rotate(360deg); } }

        /* RAINBOW */
        body.theme-rainbow { background: #f7f7f7 !important; }
        .theme-rainbow .thin-rainbow-frame { 
            position: relative; background: transparent; border: none; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); border-radius: 1.5rem; z-index: 10; overflow: hidden; padding: 3px !important; 
        }
        .theme-rainbow .thin-rainbow-frame::before { 
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; 
            background: conic-gradient(#ff0000, #ff7f00, #ffff00, #00ff00, #00ffff, #0000ff, #8b00ff, #ff0000);
            animation: spin-border 4s linear infinite; z-index: 0; 
        }
        .theme-rainbow .thin-rainbow-frame::after {
            content: ''; position: absolute; inset: 3px; background: #ffffff; border-radius: 1.3rem; z-index: 1;
        }
        .theme-rainbow .thin-rainbow-frame > * { position: relative; z-index: 5; }
        
        @keyframes spin-border { 100% { transform: rotate(360deg); } }

        .theme-rainbow #gameCard, .theme-rainbow .ranking-card { padding: 2.5rem !important; }
        .theme-rainbow #wordFrame { padding: 0; background-color: transparent; margin-bottom: 1.5rem; }
        .theme-rainbow #wordDisplay { 
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #00ffff, #0000ff, #9400d3); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; color: transparent !important; 
            animation: rainbow-text 5s ease infinite; margin-bottom: 0 !important; padding: 0 0.5rem; line-height: 1; 
        }

        /* DARK */
        body.theme-dark { background: #121212 !important; }
        .theme-dark #gameCard { background-color: rgba(18, 18, 18, 0.95) !important; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5) !important; border: none !important; padding: 2rem !important; }
        .theme-dark .card, .theme-dark .ranking-card { background-color: rgba(18, 18, 18, 0.95); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5); border: none; }
        .theme-dark header .bg-white { background-color: #374151 !important; color: #d1d5db; }
        .theme-dark header .bg-gray-50 { background-color: #121212 !important; }
        .theme-dark #wordDisplay, .theme-dark .text-gray-900, .theme-dark .rank-item .text-gray-800 { color: #f3f4f6 !important; }
        .theme-dark .text-gray-500, .theme-dark .text-gray-600, .theme-dark .text-gray-800 { color: #9ca3af !important; }
        .theme-dark .border-b { border-color: #4b5563 !important; }

        /* BANANA */
        body.theme-banana { background: #f8f4b2 !important; }
        .theme-banana #wordDisplay { color: #ffd200; animation: bounce-word 0.5s ease-out infinite alternate; }
        @keyframes bounce-word { from { transform: translateY(0); } to { transform: translateY(-15px); } }
        .theme-banana #gameCard { background-color: rgba(255, 255, 255, 0.95) !important; border: 2px solid #f4ef81 !important; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15) !important; padding: 2rem !important; }
        
        /* WINTER */
        body.theme-winter { background: linear-gradient(135deg, #e0f7fa 0%, #b3e5fc 100%) !important; }
        
        .theme-winter #wordDisplay { 
            color: transparent; 
            background-image: linear-gradient(to top, #ffffff 50%, #01579b 50%);
            background-size: 100% 220%; 
            background-position: 0 100%; 
            -webkit-background-clip: text;
            background-clip: text;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }
        
        .animate-snow-text { animation: snow-pile-text 20s linear forwards !important; }
        @keyframes snow-pile-text { 0% { background-position: 0 100%; } 100% { background-position: 0 0%; } }
        
        .theme-winter #gameCard { 
            background-color: rgba(255, 255, 255, 0.9) !important; 
            border: 2px solid #81d4fa !important; 
            box-shadow: 0 15px 40px rgba(179, 229, 252, 0.5) !important; 
            padding: 2rem !important; 
            position: relative; 
            overflow: hidden; 
        }

        #card-snow-drift { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            height: 0px; 
            background: linear-gradient(to top, #ffffff, rgba(255,255,255,0.8));
            box-shadow: 0 -5px 15px rgba(200, 235, 255, 0.9);
            border-radius: 40% 40% 0 0 / 30px 30px 0 0;
            pointer-events: none; 
            z-index: 2; 
            opacity: 0;
        }
        .animate-snow-drift { animation: snow-drift-rise 20s linear forwards !important; }
        @keyframes snow-drift-rise { 0% { height: 0px; opacity: 0.5; } 100% { height: 300px; opacity: 1; } }

        .theme-winter #snow-effect { position: fixed; inset: 0; width: 100vw; height: 100%; overflow: hidden; z-index: 40; pointer-events: none; }
        .snow-particle { position: absolute; top: -20px; border-radius: 50%; background: white; pointer-events: none; animation: snow-fall linear infinite; }
        @keyframes snow-fall { 0% { transform: translate(0, 0); opacity: 0; } 10% { opacity: 1; } 100% { transform: translate(var(--sway), 110vh); opacity: 0; } }

        /* --- SUMMER --- */
        body.theme-summer { background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%) !important; }
        .theme-summer #summer-effect { position: fixed; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: hidden; }
        
        .summer-grass {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 15vh;
            background: linear-gradient(to top, #43a047, #66bb6a);
            border-radius: 50% 50% 0 0 / 20px 20px 0 0;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            z-index: 10;
        }

        /* BASE CLOUD (Horizontal Pill) */
        .summer-cloud {
            position: absolute; background: #fff; border-radius: 50px; opacity: 0.85;
            animation: cloud-float linear infinite;
        }
        /* BUBBLES */
        .summer-cloud::after, .summer-cloud::before { content: ''; position: absolute; background: #fff; z-index: -1; border-radius: 50%; }

        /* CLOUD VARIANTS */
        .summer-cloud.v1::after { width: 50%; height: 140%; top: -60%; left: 10%; }
        .summer-cloud.v1::before { width: 60%; height: 160%; top: -80%; right: 10%; }
        .summer-cloud.v2::after { width: 40%; height: 120%; top: -50%; left: 15%; }
        .summer-cloud.v2::before { width: 40%; height: 120%; top: -50%; right: 15%; }
        .summer-cloud.v3::after { width: 70%; height: 180%; top: -100%; left: 15%; } 
        .summer-cloud.v3::before { width: 30%; height: 80%; top: -20%; right: 5%; }
        
        @keyframes cloud-float { 0% { transform: translateX(120vw); } 100% { transform: translateX(-50vw); } }

        .theme-summer #wordDisplay { 
            overflow: visible !important; 
            color: #fffde7; 
            text-shadow: 0 0 5px #fff9c4, 0 0 20px #ffeb3b, 0 0 40px #ff9800, 0 0 60px #ff5722;
            animation: sun-pulse 4s ease-in-out infinite alternate;
        }
        
        @keyframes sun-pulse {
            from { opacity: 0.9; text-shadow: 0 0 5px #fff9c4, 0 0 20px #ffeb3b, 0 0 40px #ff9800, 0 0 60px #ff5722; }
            to { opacity: 1; transform: scale(1.02); text-shadow: 0 0 10px #fff9c4, 0 0 30px #ffeb3b, 0 0 60px #ff9800, 0 0 80px #ff5722; }
        }

        .theme-summer #gameCard { 
            background-color: rgba(255, 255, 255, 0.85) !important; 
            border: 2px solid #fff !important; 
            box-shadow: 0 15px 40px rgba(0, 100, 255, 0.2) !important; 
            padding: 2rem !important; 
        }

        /* --- HALLOWEEN --- */
        body.theme-halloween { background: linear-gradient(135deg, #000000 0%, #3a0000 100%) !important; }
        .theme-halloween #wordDisplay { 
            color: #FF8C00 !important; 
            text-shadow: 2px 2px 0px #1a0000, 0 0 8px rgba(255, 140, 0, 1), 0 0 15px rgba(255, 69, 0, 0.6) !important; 
        }
        .theme-halloween .card, .theme-halloween .ranking-card { background-color: rgba(10, 0, 0, 0.9) !important; border: 2px solid #FF8C00 !important; box-shadow: 0 0 30px rgba(255, 140, 0, 0.3), 0 15px 40px rgba(0, 0, 0, 0.7) !important; }
        .theme-halloween #gameCard { padding: 2rem !important; }
        .theme-halloween .text-gray-900, .theme-halloween .rank-item .text-gray-800 { color: #F3F4F6 !important; }
        .theme-halloween .text-gray-500, .theme-halloween .text-gray-600 { color: #9CA3AF !important; }
        .theme-halloween header .bg-white { background-color: #3A015E !important; color: #d1d5db; }
        .theme-halloween header .bg-gray-50 { background-color: #1C1C1C !important; }
        .theme-halloween h2 { color: #FF8C00 !important; }
        .theme-halloween .border-b { border-color: #691C00 !important; }

        /* SUBMARINE */
        @keyframes bobbing-word { 0% { transform: translateY(0px) rotate(-1deg); } 50% { transform: translateY(-8px) rotate(1deg); } 100% { transform: translateY(0px) rotate(-1deg); } }
        body.theme-submarine { background: linear-gradient(135deg, #020c1e 0%, #0a1931 50%, #183a5a 100%) !important; }
        .theme-submarine #wordDisplay { color: #b0e0e6 !important; text-shadow: 0 0 10px rgba(176, 224, 230, 0.7), 0 0 5px rgba(255, 255, 255, 0.3) !important; animation: bobbing-word 2.5s ease-in-out infinite; }
        .theme-submarine .card, .theme-submarine .ranking-card { background-color: rgba(10, 25, 49, 0.9) !important; border: 2px solid #1c4a7a !important; box-shadow: 0 0 20px rgba(28, 74, 122, 0.5), 0 15px 40px rgba(0, 0, 0, 0.7) !important; }
        .theme-submarine #gameCard { padding: 2rem !important; }
        .theme-submarine .text-gray-900, .theme-submarine .rank-item .text-gray-800 { color: #F3F4F6 !important; }
        .theme-submarine .text-gray-500, .theme-submarine .text-gray-600 { color: #9CA3AF !important; }
        .theme-submarine header .bg-white { background-color: #0a1931 !important; color: #d1d5db; }
        .theme-submarine header .bg-gray-50 { background-color: #020c1e !important; }
        .theme-submarine h2 { color: #b0e0e6 !important; }
        .theme-submarine .border-b { border-color: #1c4a7a !important; }
        
        .theme-submarine #bubble-effect { position: fixed; inset: 0; width: 100vw; height: 100%; overflow: hidden; z-index: 40; pointer-events: none; }
        .bubble-particle { position: absolute; bottom: -50px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05) 60%, rgba(255, 255, 255, 0)); box-shadow: inset 0 0 6px rgba(255, 255, 255, 0.3), 0 0 4px rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.15); opacity: 0; z-index: 0; animation: bubble-rise-float linear infinite; }
        @keyframes bubble-rise-float { 0% { transform: translateY(0) translateX(0) scale(0.8); opacity: 0; } 10% { opacity: 1; } 50% { transform: translateY(-50vh) translateX(15px) scale(1); } 100% { transform: translateY(-120vh) translateX(-15px) scale(1.1); opacity: 0; } }

        /* --- FIRE --- */
        body.theme-fire { background-color: rgb(30, 10, 5) !important; }
        .theme-fire #gameCard, .theme-fire .ranking-card { background-color: rgba(48, 8, 8, 0.95) !important; border: 2px solid #ff5000 !important; box-shadow: 0 0 30px rgba(255, 80, 0, 0.3), 0 15px 40px rgba(0, 0, 0, 0.7) !important; padding: 2.5rem !important; }
        .theme-fire #wordDisplay { 
            color: #ffaa00 !important; 
            text-shadow: 2px 2px 0px #300, 0 0 8px #ff5000, 0 0 20px #ff0000 !important; 
            position: relative; z-index: 20;
        }
        .theme-fire .text-gray-900, .theme-fire .rank-item .text-gray-800 { color: #ffdcd0 !important; }
        .theme-fire .text-gray-500, .theme-fire .text-gray-600 { color: #a66 !important; }
        .theme-fire h2 { color: #ff5000 !important; }
        .theme-fire header .bg-white { background-color: #3d0a0a !important; color: #ffb3b3; }
        .theme-fire header .bg-gray-50 { background-color: #2b0505 !important; }
        .theme-fire .border-b { border-color: #801010 !important; }

        .theme-fire #fire-effect { position: fixed; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: hidden; }
        
        /* FLAMES: Pointy Teardrop Shape */
        .fire-particle { 
            position: absolute; bottom: -20px; 
            border-radius: 50% 0 50% 50%; 
            mix-blend-mode: screen; 
            background-image: radial-gradient(circle at 30% 70%, #ffaa00 10%, #ff0000 60%, transparent 70%); 
            opacity: 0.8; width: 8em; height: 8em; 
            transform: rotate(-45deg);
            animation: fire-rise 1.5s ease-in infinite; 
        }
        @keyframes fire-rise { from { opacity: 0.8; transform: translateY(0) scale(1) rotate(-45deg); } 100% { opacity: 0; transform: translateY(-90vh) scale(0.2) rotate(-45deg); } }

        /* SMOKE */
        .smoke-particle { 
            position: absolute; bottom: -50px; left: 50%; width: 100px; height: 100px; 
            background: radial-gradient(circle, rgba(80,80,80,0.6) 0%, rgba(0,0,0,0) 60%); 
            border-radius: 40%; filter: blur(8px); 
            animation: smoke-rise 4s linear infinite; pointer-events: none; z-index: 4; 
        }
        @keyframes smoke-rise { 0% { transform: translate(-50%, 0) scale(1); opacity: 0; } 20% { opacity: 0.5; } 100% { transform: translate(var(--sway), -80vh) scale(3); opacity: 0; } }

        /* --- PLYMOUTH THEME --- */
        body.theme-plymouth { 
            background: linear-gradient(180deg, #0f172a 0%, #334155 60%, #f97316 100%) !important; 
        }
        
        .theme-plymouth #plymouth-effect { position: fixed; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; overflow: hidden; }
        
        .plymouth-star {
            position: absolute; background: white; border-radius: 50%;
            animation: twinkle 3s infinite alternate;
        }
        @keyframes twinkle { 0% { opacity: 0.2; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1.2); } }

        .theme-plymouth #gameCard, .theme-plymouth .ranking-card {
            background-color: rgba(15, 23, 42, 0.9) !important; /* Dark Navy Glass */
            border: 1px solid #475569 !important;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5) !important;
        }
        
        .theme-plymouth #wordDisplay {
            color: #ffedd5 !important; /* Warm window light color */
            text-shadow: 0 0 10px #fb923c, 0 0 25px #ea580c; /* Sunset Orange Glow */
        }
        
        .theme-plymouth .text-gray-900, .theme-plymouth .rank-item .text-gray-800 { color: #e2e8f0 !important; }
        .theme-plymouth .text-gray-500, .theme-plymouth .text-gray-600 { color: #94a3b8 !important; }
        .theme-plymouth h2 { color: #fb923c !important; }
        .theme-plymouth header .bg-white { background-color: #1e293b !important; color: #e2e8f0; }
        .theme-plymouth header .bg-gray-50 { background-color: #0f172a !important; }
        .theme-plymouth .border-b { border-color: #334155 !important; }

        /* CRITICAL OVERRIDE CLASS */
        #wordDisplay.override-theme-color {
            color: var(--dynamic-swipe-color) !important;
            -webkit-text-fill-color: var(--dynamic-swipe-color) !important;
            background: none !important;
            text-shadow: none !important;
            filter: none !important;
        }

    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 theme-default">

    <div id="snow-effect" class="hidden"></div> 
    <div id="bubble-effect" class="hidden"></div> 
    <div id="fire-effect" class="hidden"></div>
    <div id="summer-effect" class="hidden"></div>
    <div id="plymouth-effect" class="hidden"></div>
    
    <header class="text-center mb-8 w-full max-w-lg z-20 relative">
        <div id="logoArea" class="h-32 w-full flex items-center justify-center mb-4 relative">
            <div id="leftBadgeContainer" class="absolute left-0 top-1/2 transform -translate-y-1/2 grid grid-cols-2 gap-1 pl-4">
                <div id="cakeBadge" class="p-2 cursor-pointer text-3xl hidden transition duration-300 hover:scale-110" title="The cake is a lie!">üéÇ</div>
                <div id="llamaBadge" class="p-2 cursor-pointer text-3xl hidden transition duration-300 hover:scale-110" title="The Llama has vanished!">ü¶ô</div>
                <div id="potatoBadge" class="p-2 cursor-pointer text-3xl hidden transition duration-300 hover:scale-110" title="Potatoes gonna potate.">ü•î</div>
                <div id="squirrelBadge" class="p-2 cursor-pointer text-3xl hidden transition duration-300 hover:scale-110" title="SQUIGGLE!">üêøÔ∏è</div>
            </div>
            <img src="logo.png" alt="Good Word / Bad Word Logo" class="h-full w-auto max-w-full transform translate-x-4">
            <div id="rightBadgeContainer" class="absolute right-0 top-1/2 transform -translate-y-1/2 flex flex-col items-end space-y-1 pr-4">
                <div id="contributorBadge" class="p-2 cursor-pointer text-3xl hidden transition duration-300 hover:scale-110"></div>
                <div id="awardBadge" class="p-2 cursor-pointer text-3xl transition duration-300 hover:scale-110"></div>
            </div>
        </div>
        <div class="mt-4 flex justify-around p-3 rounded-t-xl bg-white shadow-md vote-counts">
            <div id="goodTotal" class="text-xl font-bold text-green-600">GOOD: 0</div>
            <div id="badTotal" class="text-xl font-bold text-red-600">BAD: 0</div>
        </div>
        <div class="flex justify-center p-2 rounded-b-xl bg-gray-50 shadow-md">
            <div id="wordCount" class="text-sm font-semibold text-gray-500">Words: 0</div>
        </div>
    </header>

    <main id="gameCard" class="card p-8 w-full max-w-sm flex flex-col items-center rounded-2xl relative z-10">
        <div id="wordFrame" class="w-full text-center rounded-xl mb-8 relative">
            <div id="wordDisplay" class="font-extrabold text-gray-900 text-center min-h-[72px]">Loading...</div>
        </div>
        <div id="card-snow-drift"></div>
        <div class="flex space-x-4 w-full mb-3 relative z-20">
            <button id="goodButton" class="good-button flex-1 py-4 text-white text-lg font-bold rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-green-500/50" disabled>Good Word</button>
            <button id="badButton" class="bad-button flex-1 py-4 text-white text-lg font-bold rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-red-500/50" disabled>Bad Word</button>
        </div>
        <button id="notWordButton" class="not-word-button w-full py-3 text-white text-lg font-bold rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-slate-500/50 relative z-20" disabled>Not a word!</button>
        <button id="customWordButton" class="mt-4 text-sm text-gray-600 hover:text-gray-900 transition duration-150 relative z-20">Submit Custom Word</button>
    </main>

    <div id="postVoteMessage" class="mt-4 w-full max-w-sm text-center text-sm font-medium text-gray-600 min-h-[1.5rem] transition-opacity duration-500 opacity-0 relative z-10"></div>
    
    <section class="mt-8 w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
        <div class="ranking-card card p-6 rounded-xl">
            <h2 class="text-xl font-bold text-green-700 mb-4 border-b pb-2">Top Good Words</h2>
            <div class="ranking-frame rounded-xl">
                <div id="goodRankings" class="space-y-2"><p class="text-gray-500">No data yet.</p></div>
            </div>
        </div>
        <div class="ranking-card card p-6 rounded-xl">
            <h2 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">Top Bad Words</h2>
            <div class="ranking-frame rounded-xl">
                <div id="badRankings" class="space-y-2"><p class="text-gray-500">No data yet.</p></div>
            </div>
        </div>
    </section>
    
    <div class="mt-6 w-full max-w-4xl text-center relative z-10">
        <button id="showTop100Button" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-150">Show Top 100 Rankings</button>
        <button id="compareWordsButton" class="mt-4 px-6 py-2 bg-purple-600 text-white font-bold rounded-lg shadow-md hover:bg-purple-700 transition duration-150">Compare Any Two Words</button>
    </div>

    <div class="mt-6 p-4 bg-white/70 rounded-xl w-full max-w-sm flex flex-col items-center shadow-lg border border-gray-100 relative z-10">
        <h3 class="text-lg font-bold text-gray-700 mb-2">Unlocked Themes üé®</h3>
        <select id="themeChooser" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 font-semibold">
            <option value="default">Default</option>
        </select>
        <p id="themeUnlockHint" class="text-xs text-gray-500 mt-2">Vote on special words to unlock new themes!</p>
        <div class="mt-4 flex space-x-2 w-full">
            <button id="showSettingsButton" class="flex-1 px-3 py-2 bg-slate-200 text-gray-700 font-bold rounded-lg shadow-md hover:bg-slate-300 transition duration-150 text-xs">‚öôÔ∏è Settings</button>
            <a href="mailto:gileswendes@gmail.com" class="flex-1 flex items-center justify-center px-3 py-2 bg-indigo-100 text-indigo-700 font-bold rounded-lg shadow-md hover:bg-indigo-200 transition duration-150 text-xs">‚úâÔ∏è Contact</a>
        </div>
    </div>
    
    <div id="submissionModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl">
            <h2 class="text-2xl font-bold mb-4">Submit a New Word</h2>
            <input type="text" id="newWordInput" placeholder="Enter your word here..." class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500">
            <div id="modalMessage" class="text-sm text-red-500 mb-4"></div>
            <div class="flex justify-end space-x-3">
                <button id="cancelSubmitButton" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300">Cancel</button>
                <button id="submitWordButton" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700">Submit Word</button>
            </div>
        </div>
    </div>
    
    <div id="fullRankingsModalContainer" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-6xl max-h-[90vh] shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold">Top 100 Word Rankings</h2>
                <button id="closeFullRankingsModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold leading-none">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-green-50/50 p-4 rounded-lg shadow-inner flex flex-col"><h3 class="text-xl font-semibold mb-4 text-green-700">Top 100 Good Words</h3><div id="fullGoodRankings" class="space-y-1"></div></div>
                    <div class="bg-red-50/50 p-4 rounded-lg shadow-inner flex flex-col"><h3 class="text-xl font-semibold mb-4 text-red-700">Top 100 Bad Words</h3><div id="fullBadRankings" class="space-y-1"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="definitionModalContainer" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-lg shadow-2xl flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 id="definitionWord" class="text-2xl font-bold">DEFINITION</h2>
                <button id="closeDefinitionModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold leading-none">&times;</button>
            </div>
            <div id="definitionResults" class="space-y-4 overflow-y-auto"><p>Loading definition...</p></div>
        </div>
    </div>

    <div id="compareModalContainer" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-2xl shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold">Compare Any Two Words</h2>
                <button id="closeCompareModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold leading-none">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="flex flex-col md:flex-row gap-3">
                    <input type="text" id="wordOneInput" placeholder="First word..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    <input type="text" id="wordTwoInput" placeholder="Second word..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div id="compareResults" class="p-3 bg-gray-50 rounded-lg min-h-[50px] flex flex-col items-center justify-center text-gray-500">Type two words above to see who wins!</div>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="runComparisonButton" class="px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition">Compare</button>
            </div>
        </div>
    </div>
    
    <div id="settingsModalContainer" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold">User Settings</h2>
                <button id="closeSettingsModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold leading-none">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between"><label for="togglePercentages" class="text-lg font-medium text-gray-700">Show Vote Percentages</label><input type="checkbox" id="togglePercentages" class="h-6 w-6 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"></div>
                <div class="flex items-center justify-between"><label for="toggleTips" class="text-lg font-medium text-gray-700">Show Tips & Hints</label><input type="checkbox" id="toggleTips" class="h-6 w-6 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"></div>
            </div>
            <div class="mt-6 border-t pt-4">
                <p class="text-sm text-gray-500">Clear all local data? Irreversible.</p>
                <button id="clearAllDataButton" class="mt-3 px-4 py-2 w-full bg-red-500 text-white font-medium rounded-lg shadow-md hover:bg-red-600 transition">Clear All Local Data</button>
            </div>
        </div>
    </div>
    
    <div class="version-indicator"></div>

    <script>
        /**
         * 1. CONFIGURATION & CONSTANTS
         */
        const CONFIG = {
            API_BASE_URL: '/api/words',
            APP_VERSION: '4.9.9.1',
            SPECIAL_WORDS: {
                CAKE: { text: 'CAKE', prob: 0.005, fade: 300, msg: "The cake is a lie!", msgDur: 3000 },
                LLAMA: { text: 'LLAMA', prob: 0.005, fade: 8000, msg: "what llama?", msgDur: 2000 },
                POTATO: { text: 'POTATO', prob: 0.005, fade: 300, msg: "Potatoes gonna potate.", msgDur: 2000 },
                SQUIRREL: { text: 'SQUIRREL', prob: 0.005, fade: 300, msg: "SQUIGGLE!", msgDur: 1500 }
            },
            CONTRIBUTION_THRESHOLD: 5,
            BOOST_FACTOR: 2.0,
            TIP_COOLDOWN: 4,
            HISTORY_SIZE: 300,
            VOTE: {
                MASH_LIMIT: 5,
                COOLDOWN_SEC: 10,
                STREAK_WINDOW: 1500,
                SWIPE_THRESHOLD: 100
            },
            THEME_SECRETS: {
                'rainbow': 'UkFJTkJPV3xHQVl8U1BBUktMRXxDT0xPVVJ8UFJJREV8VU5JQ09STnxQUk9VRHxRVUVFUnxHTElUVEVSfExFU0JJQU58VElOU0VM',
                'dark': 'TUlETklHSFR8QkxBQ0t8U0hBREV8R09USHxTSEFET1d8TklOSkF8REFSS3xOSUdIVHxTVEVBTFRI',
                'banana': 'QkFOQU5BfEJBTkFOQVN8UExBTlRBSU58WUVMTE9XfFNQTElUfE1vbktFWXxIQU1NT0NL',
                'winter': 'U05PV01BTnxTTk9XfElDRXxXSU5URVJ8RlJPWkVOfENISUxMfENPTER8RkxBS0V8QkxJWlpBUkR8SUNJQ0xFfFNMRUlHSHxTTk9XQkFMTHxTQ0FSRnxKQUNLRVR8U0xFREdFfE5PVkVNQkVSfERFQ0VNQkVSfEpBTlVBUll8SklOR0xF',
                'summer': 'U1VNTUVSfEhPVHxCRUFDSHxIT0xJREFZfFNVTnxWQUNBVElPTnxTV0lNfFNBTkR8UE9PTHxKVUxZfEFVR1VTVHxKVU5F',
                'halloween': 'SEFMTE9XRUVOfEdIT1NUfFBVTVBLSU58U1BJREVSfFNXRUVUU3xDT1NUVU1FfFNQT09LWXxPQ1RPQkVSfFdJVENIfFZBTVBJUkV8Wk9NQklFfEJBVHxNT05TVEVS',
                'submarine': 'U1VCTUFSSU5FfFdBVEVSfFdBVkVTfFBMWU1PVVRIfEJSSVhIQU18UElSQVRFfFNFQXxBUVVBVElDfEFRVUF8REVFUHxPQ1RPUFVTfFJVTXxTSElQ',
                'fire': 'RklSRXxCVVJOfEhPVHxIRUxMfElORkVSTk98RkxBTUV8Q09BTFN8Q1JBQ0tMRXxUT0FTVHxIRUFU',
                'plymouth': 'UExZTU9VVEh8U1VOU0VUfFRXSUxJR0hUfEhPUklaT058T0NFQU5DSVRZfERFVk9OfFNPVVRIV0VTVA=='
            },
            TIPS: [
                "Tip: Drag the word left for good and right for bad.", "Tip: Try comparing words!", "Tip: Tap the word for a definition.",
                "Tip: Check the theme chooser.", "Tip: Turn off messages in Settings.", "Tip: Don't go mistaking your house burning down for the dawn.",
                "Tip: Go outside for a stomp?", "Tip: Nobody else has a clue either.", "Tip: I've got a floor, so what?",
                "Tip: Wear sunscreen.", "Tip: How thick is wall?", "Tip: Ask them out for a coffee.", "Tip: Can you smell burning toast?",
                "Tip: Time is an illusion. Lunchtime doubly so.", "Tip: It is better to keep your mouth closed and let people think you are a fool than to open it and remove all doubt.",
                "Tip: It's the things that are given, not won, are the things that you earned", "Tip: I'm so glad that you exist.", "Tip: Play with friends! Not this, something classic like Tetris or chess.",
                "Tip: Move into the country, eat a lot of peaches.", "Tip: I wish there was a way to know you're in the good old days, before you've actually left them."
            ]
        };

        /**
         * 2. STATE MANAGEMENT
         */
        const State = {
            data: {
                userId: localStorage.getItem('userId') || crypto.randomUUID(),
                voteCount: parseInt(localStorage.getItem('voteCount') || 0),
                contributorCount: parseInt(localStorage.getItem('contributorCount') || 0),
                badges: {
                    cake: localStorage.getItem('cakeBadgeUnlocked') === 'true',
                    llama: localStorage.getItem('llamaBadgeUnlocked') === 'true',
                    potato: localStorage.getItem('potatoBadgeUnlocked') === 'true',
                    squirrel: localStorage.getItem('squirrelBadgeUnlocked') === 'true',
                },
                settings: JSON.parse(localStorage.getItem('userSettings')) || { showTips: true, showPercentages: true },
                currentTheme: localStorage.getItem('currentTheme') || 'default',
                unlockedThemes: JSON.parse(localStorage.getItem('unlockedThemes')) || [],
                voteCounterForTips: parseInt(localStorage.getItem('voteCounterForTips')) || 0,
                manualTheme: localStorage.getItem('manualTheme') === 'true',
            },
            runtime: {
                allWords: [],
                currentWordIndex: 0,
                history: [],
                streak: 0,
                lastVoteTime: 0,
                isCoolingDown: false,
                cooldownTimer: null
            },
            save(key, value) {
                this.data[key] = value;
                if(key === 'settings') localStorage.setItem('userSettings', JSON.stringify(value));
                else if(key === 'unlockedThemes') localStorage.setItem('unlockedThemes', JSON.stringify(value));
                else if(key.startsWith('badge_')) localStorage.setItem(key, value); 
                else localStorage.setItem(key, value);
            },
            unlockBadge(name) {
                this.data.badges[name] = true;
                localStorage.setItem(`${name}BadgeUnlocked`, 'true');
            },
            incrementVote() {
                this.data.voteCount++;
                localStorage.setItem('voteCount', this.data.voteCount);
            },
            incrementContributor() {
                this.data.contributorCount++;
                localStorage.setItem('contributorCount', this.data.contributorCount);
            },
            clearAll() {
                if (confirm("Clear all local data? Irreversible.")) {
                    localStorage.clear();
                    window.location.reload();
                }
            }
        };

        if (!localStorage.getItem('userId')) localStorage.setItem('userId', State.data.userId);

        /**
         * 3. DOM ELEMENTS CACHE
         */
        const DOM = {
            header: {
                logoArea: document.getElementById('logoArea'),
                goodTotal: document.getElementById('goodTotal'),
                badTotal: document.getElementById('badTotal'),
                wordCount: document.getElementById('wordCount'),
                badges: {
                    cake: document.getElementById('cakeBadge'),
                    llama: document.getElementById('llamaBadge'),
                    potato: document.getElementById('potatoBadge'),
                    squirrel: document.getElementById('squirrelBadge'),
                    award: document.getElementById('awardBadge'),
                    contributor: document.getElementById('contributorBadge')
                }
            },
            game: {
                card: document.getElementById('gameCard'),
                wordFrame: document.getElementById('wordFrame'),
                wordDisplay: document.getElementById('wordDisplay'),
                buttons: {
                    good: document.getElementById('goodButton'),
                    bad: document.getElementById('badButton'),
                    notWord: document.getElementById('notWordButton'),
                    custom: document.getElementById('customWordButton')
                },
                message: document.getElementById('postVoteMessage')
            },
            rankings: {
                good: document.getElementById('goodRankings'),
                bad: document.getElementById('badRankings'),
                fullGood: document.getElementById('fullGoodRankings'),
                fullBad: document.getElementById('fullBadRankings'),
                btnShow: document.getElementById('showTop100Button')
            },
            theme: {
                chooser: document.getElementById('themeChooser'),
                hint: document.getElementById('themeUnlockHint'),
                effects: {
                    snow: document.getElementById('snow-effect'),
                    bubble: document.getElementById('bubble-effect'),
                    fire: document.getElementById('fire-effect'),
                    summer: document.getElementById('summer-effect'),
                    plymouth: document.getElementById('plymouth-effect')
                }
            },
            modals: {
                submission: document.getElementById('submissionModal'),
                fullRankings: document.getElementById('fullRankingsModalContainer'),
                definition: document.getElementById('definitionModalContainer'),
                compare: document.getElementById('compareModalContainer'),
                settings: document.getElementById('settingsModalContainer')
            },
            inputs: {
                newWord: document.getElementById('newWordInput'),
                wordOne: document.getElementById('wordOneInput'),
                wordTwo: document.getElementById('wordTwoInput'),
                modalMsg: document.getElementById('modalMessage'),
                compareResults: document.getElementById('compareResults'),
                settings: {
                    tips: document.getElementById('toggleTips'),
                    percentages: document.getElementById('togglePercentages')
                }
            },
            general: {
                version: document.querySelector('.version-indicator')
            }
        };

        /**
         * 4. HELPER SERVICES
         */
        const API = {
            async fetchWords() {
                try {
                    const res = await fetch(CONFIG.API_BASE_URL);
                    if (!res.ok) throw new Error(res.status);
                    return await res.json();
                } catch (e) { console.error(e); return null; }
            },
            async vote(wordId, voteType) {
                return fetch(`${CONFIG.API_BASE_URL}/${wordId}/vote`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voteType, userId: State.data.userId })
                });
            },
            async submitWord(text) {
                return fetch(CONFIG.API_BASE_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text })
                });
            },
            async define(word) {
                return fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word.toLowerCase()}`);
            }
        };

        const ThemeManager = {
            decodedThemes: {},
            init() {
                Object.keys(CONFIG.THEME_SECRETS).forEach(k => {
                    try { this.decodedThemes[k] = atob(CONFIG.THEME_SECRETS[k]).split('|'); } 
                    catch { this.decodedThemes[k] = []; }
                });
                this.populateChooser();
                this.apply(State.data.currentTheme);
            },
            populateChooser() {
                const avail = [...new Set(State.data.unlockedThemes)].sort();
                Object.keys(this.decodedThemes).forEach(k => { if(State.data.unlockedThemes.includes(k) && !avail.includes(k)) avail.push(k); });
                avail.sort();

                DOM.theme.chooser.innerHTML = '<option value="default">Default</option>';
                avail.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t; opt.textContent = t.charAt(0).toUpperCase() + t.slice(1);
                    DOM.theme.chooser.appendChild(opt);
                });
                DOM.theme.chooser.value = State.data.currentTheme;
                DOM.theme.hint.textContent = avail.length > 0 ? `You have ${avail.length} themes unlocked!` : `Vote on special words to unlock new themes!`;
            },
            apply(theme, manual = false) {
                if (manual) {
                    State.save('manualTheme', true);
                }

                document.body.className = document.body.className.split(' ').filter(c => !c.startsWith('theme-')).join(' ');
                document.body.classList.add(`theme-${theme}`);
                State.save('currentTheme', theme);
                
                // Toggle Effects
                DOM.theme.effects.snow.classList.toggle('hidden', theme !== 'winter');
                if (theme === 'winter') Effects.snow(); else DOM.theme.effects.snow.innerHTML = '';

                DOM.theme.effects.bubble.classList.toggle('hidden', theme !== 'submarine');
                if (theme === 'submarine') Effects.bubbles(); else DOM.theme.effects.bubble.innerHTML = '';

                DOM.theme.effects.fire.classList.toggle('hidden', theme !== 'fire');
                if (theme === 'fire') Effects.fire(); else DOM.theme.effects.fire.innerHTML = '';
                
                DOM.theme.effects.summer.classList.toggle('hidden', theme !== 'summer');
                if (theme === 'summer') Effects.summer(); else DOM.theme.effects.summer.innerHTML = '';

                DOM.theme.effects.plymouth.classList.toggle('hidden', theme !== 'plymouth');
                if (theme === 'plymouth') Effects.plymouth(); else DOM.theme.effects.plymouth.innerHTML = '';

                const cards = document.querySelectorAll('.card, .ranking-card');
                const isRainbow = theme === 'rainbow';
                [DOM.game.card, ...cards].forEach(el => {
                    if(!el) return;
                    if(isRainbow) { el.classList.add('thin-rainbow-frame'); el.classList.remove('card'); }
                    else { el.classList.remove('thin-rainbow-frame'); el.classList.add('card'); }
                });
                
                // Explicitly hide snow drift if not winter
                const drift = document.getElementById('card-snow-drift');
                if (theme !== 'winter') {
                    drift.style.display = 'none';
                } else {
                    drift.style.display = 'block';
                }
                
                if (State.runtime.allWords.length > 0) UIManager.displayWord(State.runtime.allWords[State.runtime.currentWordIndex]);
            },
            checkUnlock(wordText) {
                const upper = wordText.toUpperCase();
                let unlocked = null;
                for (const [key, list] of Object.entries(this.decodedThemes)) {
                    if (list.includes(upper)) { unlocked = key; break; }
                }
                if (unlocked && !State.data.unlockedThemes.includes(unlocked)) {
                    State.data.unlockedThemes.push(unlocked);
                    State.save('unlockedThemes', State.data.unlockedThemes);
                    this.populateChooser();
                    if (!State.data.manualTheme) {
                        this.apply(unlocked);
                    }
                    return true;
                }
                return false;
            }
        };

        const Effects = {
            fire() {
                const container = DOM.theme.effects.fire;
                container.innerHTML = '';
                for (let i = 0; i < 60; i++) { 
                    const p = document.createElement('div'); p.className = 'fire-particle';
                    p.style.animationDelay = `${Math.random()}s`;
                    p.style.left = `calc(10% + (80% * ${Math.random()}))`;
                    container.appendChild(p);
                }
                for (let i = 0; i < 15; i++) {
                    const s = document.createElement('div'); s.className = 'smoke-particle';
                    s.style.animationDelay = `${Math.random() * 3}s`;
                    s.style.left = `${Math.random() * 90 + 5}%`;
                    s.style.setProperty('--sway', `${(Math.random()-0.5)*150}px`);
                    container.appendChild(s);
                }
            },
            bubbles() {
                const container = DOM.theme.effects.bubble;
                container.innerHTML = '';
                const clusters = [10, 30, 70, 90];
                for (let i = 0; i < 40; i++) {
                    const p = document.createElement('div'); p.className = 'bubble-particle';
                    const size = Math.random() * 30 + 10;
                    p.style.width = p.style.height = `${size}px`;
                    const left = clusters[Math.floor(Math.random() * clusters.length)] + (Math.random() - 0.5) * 20;
                    p.style.left = `${left}%`;
                    p.style.animationDuration = `${Math.random() * 10 + 10}s`;
                    p.style.animationDelay = `-${Math.random() * 15}s`;
                    container.appendChild(p);
                }
            },
            snow() {
                const container = DOM.theme.effects.snow;
                container.innerHTML = '';
                for (let i = 0; i < 60; i++) {
                    const f = document.createElement('div'); f.className = 'snow-particle';
                    const size = Math.random() * 12 + 5;
                    f.style.width = f.style.height = `${size}px`;
                    f.style.opacity = Math.random() * 0.6 + 0.3;
                    if (size < 4) f.style.filter = `blur(${Math.random()*2}px)`;
                    f.style.left = `${Math.random() * 100}vw`;
                    f.style.setProperty('--sway', `${(Math.random()-0.5)*100}px`);
                    f.style.animationDuration = `${Math.random()*15 + 8}s`;
                    f.style.animationDelay = `-${Math.random()*15}s`;
                    container.appendChild(f);
                }
            },
            summer() {
                const container = DOM.theme.effects.summer;
                container.innerHTML = '';
                const grass = document.createElement('div');
                grass.className = 'summer-grass';
                container.appendChild(grass);
                for (let i = 0; i < 8; i++) {
                    const c = document.createElement('div');
                    const variant = Math.floor(Math.random() * 3) + 1;
                    c.className = `summer-cloud v${variant}`;
                    const width = Math.random() * 100 + 100; 
                    c.style.width = `${width}px`;
                    c.style.height = `${width * 0.35}px`; 
                    c.style.top = `${Math.random() * 60}%`; 
                    const duration = Math.random() * 60 + 60; 
                    c.style.animationDuration = `${duration}s`;
                    c.style.animationDelay = `-${Math.random() * 100}s`; 
                    container.appendChild(c);
                }
            },
            plymouth() {
                const container = DOM.theme.effects.plymouth;
                container.innerHTML = '';
                for (let i = 0; i < 50; i++) {
                    const s = document.createElement('div');
                    s.className = 'plymouth-star';
                    const size = Math.random() * 3 + 1;
                    s.style.width = s.style.height = `${size}px`;
                    s.style.top = `${Math.random() * 50}%`; // Top half only
                    s.style.left = `${Math.random() * 100}%`;
                    s.style.animationDuration = `${Math.random() * 3 + 2}s`;
                    s.style.animationDelay = `-${Math.random() * 5}s`;
                    container.appendChild(s);
                }
            }
        };

        const ModalManager = {
            toggle(id, show) {
                const el = DOM.modals[id];
                if(show) { el.classList.remove('hidden'); el.classList.add('flex'); }
                else { el.classList.remove('flex'); el.classList.add('hidden'); }
            },
            init() {
                document.getElementById('showSettingsButton').onclick = () => {
                    DOM.inputs.settings.tips.checked = State.data.settings.showTips;
                    DOM.inputs.settings.percentages.checked = State.data.settings.showPercentages;
                    this.toggle('settings', true);
                };
                document.getElementById('closeSettingsModal').onclick = () => this.toggle('settings', false);
                DOM.inputs.settings.tips.onchange = (e) => State.save('settings', {...State.data.settings, showTips: e.target.checked});
                DOM.inputs.settings.percentages.onchange = (e) => State.save('settings', {...State.data.settings, showPercentages: e.target.checked});
                
                DOM.game.buttons.custom.onclick = () => { DOM.inputs.newWord.value = ''; DOM.inputs.modalMsg.textContent = ''; this.toggle('submission', true); };
                document.getElementById('cancelSubmitButton').onclick = () => this.toggle('submission', false);
                
                DOM.rankings.btnShow.onclick = () => { UIManager.renderFullRankings(); this.toggle('fullRankings', true); };
                document.getElementById('closeFullRankingsModal').onclick = () => this.toggle('fullRankings', false);
                
                document.getElementById('compareWordsButton').onclick = () => { DOM.inputs.wordOne.value = ''; DOM.inputs.wordTwo.value = ''; DOM.inputs.compareResults.innerHTML = 'Type words above to see who wins!'; this.toggle('compare', true); };
                document.getElementById('closeCompareModal').onclick = () => this.toggle('compare', false);
                
                DOM.game.wordDisplay.onclick = () => Game.showDefinition();
                document.getElementById('closeDefinitionModal').onclick = () => this.toggle('definition', false);

                Object.keys(DOM.modals).forEach(k => {
                    DOM.modals[k].addEventListener('click', (e) => { if(e.target === DOM.modals[k]) this.toggle(k, false); });
                });
            }
        };

        const UIManager = {
            msgTimeout: null,
            showMessage(text, isError = false) {
                const wd = DOM.game.wordDisplay;
                wd.textContent = text;
                wd.className = `text-4xl font-bold text-center min-h-[72px] ${isError ? 'text-red-500' : 'text-gray-500'}`;
                wd.style.fontSize = '1.0rem'; wd.style.cursor = 'default';
                DOM.game.wordFrame.style.padding = '0';
                this.disableButtons(true);
            },
            disableButtons(disabled) {
                Object.values(DOM.game.buttons).forEach(b => { if(!b.id.includes('custom')) b.disabled = disabled; });
            },
            showPostVoteMessage(msg) {
                const el = DOM.game.message;
                if(this.msgTimeout) clearTimeout(this.msgTimeout);
                el.classList.remove('opacity-100'); el.classList.add('opacity-0');
                setTimeout(() => {
                    el.innerHTML = msg;
                    el.classList.remove('opacity-0'); el.classList.add('opacity-100');
                    this.msgTimeout = setTimeout(() => { el.classList.remove('opacity-100'); el.classList.add('opacity-0'); }, 5000);
                }, 150);
            },
            updateStats() {
                const words = State.runtime.allWords;
                if(!words.length) return;
                const totalGood = words.reduce((s,w) => s + (w.goodVotes||0), 0);
                const totalBad = words.reduce((s,w) => s + (w.badVotes||0), 0);
                DOM.header.goodTotal.textContent = `GOOD: ${totalGood}`;
                DOM.header.badTotal.textContent = `BAD: ${totalBad}`;
                DOM.header.wordCount.textContent = `Words in Database: ${words.length}`;
                
                if(State.data.contributorCount >= CONFIG.CONTRIBUTION_THRESHOLD) {
                    DOM.header.badges.contributor.textContent = '‚úçÔ∏è';
                    DOM.header.badges.contributor.classList.remove('hidden');
                }
                
                let star = 'üò∂', title = 'Next Award: Bronze (5 Votes)';
                const v = State.data.voteCount;
                if(v >= 250) { star='üèÜ'; title='Platinum Star!'; }
                else if(v >= 50) { star='üåü'; title='Gold Star!'; }
                else if(v >= 25) { star='ü•à'; title='Silver Star!'; }
                else if(v >= 5) { star='ü•â'; title='Bronze Star!'; }
                DOM.header.badges.award.textContent = star;
                DOM.header.badges.award.title = title;

                const b = State.data.badges;
                DOM.header.badges.cake.classList.toggle('hidden', !b.cake);
                DOM.header.badges.llama.classList.toggle('hidden', !b.llama);
                DOM.header.badges.potato.classList.toggle('hidden', !b.potato);
                DOM.header.badges.squirrel.classList.toggle('hidden', !b.squirrel);

                this.renderMiniRankings();
            },
            displayWord(wordObj) {
                if(!wordObj) { this.showMessage("No words available!"); return; }
                const wd = DOM.game.wordDisplay;
                const txt = wordObj.text.toUpperCase();
                wd.textContent = txt;
                
                wd.className = 'font-extrabold text-gray-900 text-center min-h-[72px]';
                wd.style = ''; 
                wd.style.opacity = '1';
                
                const t = State.data.currentTheme;
                if (['dark','halloween','submarine','fire'].includes(t)) wd.style.color = '#f3f4f6';
                if (t === 'halloween') { 
                    wd.style.color = '#FF8C00'; 
                    wd.style.textShadow = '2px 2px 0px #1a0000, 0 0 8px rgba(255,140,0,1), 0 0 15px rgba(255,69,0,0.6)'; 
                }
                if (t === 'submarine') { wd.style.color = '#b0e0e6'; wd.style.textShadow = '0 0 10px rgba(176,224,230,0.7), 0 0 5px rgba(255,255,255,0.3)'; wd.style.animation = 'bobbing-word 2.5s ease-in-out infinite'; }
                if (t === 'fire') { 
                    wd.style.color = '#ffaa00'; 
                    wd.style.textShadow = '2px 2px 0px #300, 0 0 8px #ff5000, 0 0 20px #ff0000'; 
                }
                if (t === 'banana') { wd.style.color = '#ffd200'; wd.style.animation = 'bounce-word 0.5s ease-out infinite alternate'; }
                if (t === 'winter') { 
                    wd.style.color = '#01579b'; 
                    wd.classList.remove('animate-snow-text');
                    void wd.offsetWidth; // Trigger Reflow for Animation Reset
                    wd.classList.add('animate-snow-text');
                }
                if (t === 'summer') { 
                    wd.style.color = '#fffde7'; 
                    // Tighter initial shadow (5px) to remove the "hard edge"
                    wd.style.textShadow = '0 0 5px #fff9c4, 0 0 20px #ffeb3b, 0 0 40px #ff9800, 0 0 70px #ff5722';
                    wd.style.animation = 'sun-pulse 4s ease-in-out infinite alternate'; 
                } else if (t === 'plymouth') {
                    wd.style.color = '#ffedd5';
                    wd.style.textShadow = '0 0 10px #fb923c, 0 0 25px #ea580c';
                } else {
                    if(t !== 'banana' && t !== 'rainbow' && t !== 'submarine') wd.style.animation = 'none';
                }
                
                if (t === 'rainbow') { 
                    wd.style.background = 'linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #00ffff, #0000ff, #9400d3)';
                    wd.style.webkitBackgroundClip = 'text'; wd.style.webkitTextFillColor = 'transparent'; wd.style.color = 'transparent';
                    wd.style.animation = 'rainbow-text 5s ease infinite';
                }

                // Reset Drift
                const drift = document.getElementById('card-snow-drift');
                if(t === 'winter') {
                    drift.classList.remove('animate-snow-drift');
                    void drift.offsetWidth;
                    drift.classList.add('animate-snow-drift');
                } else {
                    drift.style.height = '0';
                }

                this.fitText(txt);
                
                if(!State.runtime.isCoolingDown) this.disableButtons(false);
                wd.style.cursor = 'grab';
            },
            fitText(text) {
                const wd = DOM.game.wordDisplay;
                const cardW = DOM.game.card.clientWidth - parseFloat(window.getComputedStyle(DOM.game.card).paddingLeft) * 2;
                wd.style.fontSize = '96px';
                wd.style.whiteSpace = 'nowrap';
                if(wd.scrollWidth > cardW) {
                    const scale = cardW / wd.scrollWidth;
                    wd.style.fontSize = Math.max(24, Math.floor(96 * scale)) + 'px';
                }
                wd.style.whiteSpace = 'normal';
            },
            renderRankingsImpl(container, list, type, isFull) {
                container.innerHTML = '';
                if(!list.length) { container.innerHTML = `<p class="text-gray-500">No data yet.</p>`; return; }
                list.forEach((w, i) => {
                    const div = document.createElement('div');
                    div.className = `flex justify-between items-center py-1 ${isFull?'full-ranking-item text-sm':'rank-item'}`;
                    const bg = type === 'good' ? 'bg-green-500' : 'bg-red-500';
                    const val = type === 'good' ? w.score : Math.abs(w.score);
                    div.innerHTML = `
                        <div class="flex items-center ${isFull?'space-x-3':'space-x-2'}">
                            <span class="font-bold ${isFull?'text-base w-8':'text-lg w-5'} text-center text-gray-500 flex-shrink-0">${i+1}.</span>
                            <span class="font-medium text-gray-800">${w.text.toUpperCase()}</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span class="text-xs text-white ${bg} px-2 rounded-full font-bold">${val}</span>
                            <span class="text-sm text-gray-600">(${w.good} / ${w.bad})</span>
                        </div>`;
                    container.appendChild(div);
                });
            },
            getRankedLists(limit) {
                const raw = State.runtime.allWords.map(w => ({ text: w.text, good: w.goodVotes||0, bad: w.badVotes||0, score: (w.goodVotes||0)-(w.badVotes||0) }));
                const topGood = [...raw].sort((a,b) => (b.score - a.score) || ((b.good+b.bad)-(a.good+a.bad))).slice(0,limit);
                const topBad = [...raw].sort((a,b) => (a.score - b.score) || ((b.good+b.bad)-(a.good+a.bad))).slice(0,limit);
                return { topGood, topBad };
            },
            renderMiniRankings() {
                const { topGood, topBad } = this.getRankedLists(5);
                this.renderRankingsImpl(DOM.rankings.good, topGood, 'good', false);
                this.renderRankingsImpl(DOM.rankings.bad, topBad, 'bad', false);
            },
            renderFullRankings() {
                const { topGood, topBad } = this.getRankedLists(100);
                this.renderRankingsImpl(DOM.rankings.fullGood, topGood, 'good', true);
                this.renderRankingsImpl(DOM.rankings.fullBad, topBad, 'bad', true);
            }
        };

        /**
         * 5. GAME LOGIC CONTROLLER
         */
        const Game = {
            cleanStyles(wd) {
                wd.style.animation = 'none';
                wd.style.background = 'none';
                wd.style.webkitTextFillColor = 'initial';
                wd.style.textShadow = 'none';
                wd.style.transform = 'none';
                wd.style.filter = 'none';
                wd.style.color = ''; // Reset color
            },

            async init() {
                DOM.general.version.textContent = `v${CONFIG.APP_VERSION} | Made by Gilxs`;
                DOM.game.buttons.good.onclick = () => this.vote('good');
                DOM.game.buttons.bad.onclick = () => this.vote('bad');
                DOM.game.buttons.notWord.onclick = () => this.vote('notWord');
                
                DOM.header.badges.cake.onclick = () => this.loadSpecial(CONFIG.SPECIAL_WORDS.CAKE.text);
                DOM.header.badges.llama.onclick = () => this.loadSpecial(CONFIG.SPECIAL_WORDS.LLAMA.text);
                DOM.header.badges.potato.onclick = () => this.loadSpecial(CONFIG.SPECIAL_WORDS.POTATO.text);
                DOM.header.badges.squirrel.onclick = () => this.loadSpecial(CONFIG.SPECIAL_WORDS.SQUIRREL.text);
                DOM.header.badges.award.onclick = () => UIManager.showPostVoteMessage(`üèÜ Total Votes Cast: ${State.data.voteCount}`);
                DOM.header.badges.contributor.onclick = () => UIManager.showPostVoteMessage(`‚úçÔ∏è You Submitted: ${State.data.contributorCount}`);

                document.getElementById('submitWordButton').onclick = async () => {
                    const txt = DOM.inputs.newWord.value.trim();
                    if(!txt || txt.includes(' ') || txt.length>45) { DOM.inputs.modalMsg.textContent="Invalid word."; return; }
                    const btn = document.getElementById('submitWordButton'); btn.disabled = true;
                    try {
                        const res = await API.submitWord(txt);
                        if(res.status === 201) {
                            State.incrementContributor();
                            DOM.inputs.modalMsg.textContent = "Success!";
                            setTimeout(() => { ModalManager.toggle('submission', false); this.refreshData(); }, 1000);
                        } else {
                            const d = await res.json(); DOM.inputs.modalMsg.textContent = d.message || "Error";
                        }
                    } catch(e) { DOM.inputs.modalMsg.textContent = "Network Error"; }
                    btn.disabled = false;
                };

                document.getElementById('runComparisonButton').onclick = async () => {
                   // Comparison logic
                   const w1Input = DOM.inputs.wordOne.value.trim(); 
                   const w2Input = DOM.inputs.wordTwo.value.trim();
                   if(!w1Input && !w2Input) { DOM.inputs.compareResults.innerHTML = '<span class="text-red-500">Please enter at least one word.</span>'; return; }
                   DOM.inputs.compareResults.innerHTML = '<span class="text-gray-500 animate-pulse">Analyzing words...</span>';
                   
                   const getWordData = async (w) => {
                       if (w.includes(' ') || w.length > 45) return { t: w, valid: false, err: 'Invalid word.' };
                       const exist = State.runtime.allWords.find(x => x.text.toUpperCase() === w.toUpperCase());
                       if(exist) return { t: exist.text, valid: true, exists: true, d: exist };
                       const r = await API.submitWord(w);
                       if(r.status === 201) { State.incrementContributor(); return { t: w.toUpperCase(), valid: true, exists: false, isNew: true }; }
                       return { t: w, valid: false, err: 'Could not fetch data.' };
                   };

                   const results = [];
                   if(w1Input) results.push(await getWordData(w1Input));
                   if(w2Input) results.push(await getWordData(w2Input));
                   
                   if(results.some(r => r.isNew)) this.refreshData(false);

                   if(results.some(r => !r.valid)) {
                       DOM.inputs.compareResults.innerHTML = results.map(r => !r.valid ? `<p class="text-red-500 mb-2"><strong>${r.t}</strong>: ${r.err}</p>` : '').join('');
                       return;
                   }

                   const stats = results.map(r => {
                       if(r.isNew) return { text: r.t.toUpperCase(), score: 0, good: 0, bad: 0, total: 0, approval: 0, isNew: true };
                       const g = r.d.goodVotes || 0;
                       const b = r.d.badVotes || 0;
                       const total = g + b;
                       return { 
                           text: r.t.toUpperCase(), 
                           score: g - b, 
                           good: g, 
                           bad: b, 
                           total: total, 
                           approval: total > 0 ? Math.round((g / total) * 100) : 0,
                           isNew: false
                       };
                   });

                   let html = '';
                   if(stats.length === 2) {
                       const [s1, s2] = stats;
                       let winnerIdx = -1;
                       if (s1.score !== s2.score) winnerIdx = s1.score > s2.score ? 0 : 1;
                       
                       html = `<div class="flex flex-col md:flex-row gap-4 w-full justify-center items-stretch">`;
                       stats.forEach((s, idx) => {
                           const isWinner = idx === winnerIdx;
                           const isLoser = winnerIdx !== -1 && !isWinner;
                           const borderClass = isWinner ? 'border-yellow-400 bg-yellow-50 shadow-xl scale-105 z-10' : 'border-gray-200 bg-white';
                           const opacityClass = isLoser ? 'opacity-70 grayscale-[0.3]' : '';
                           html += `<div class="flex-1 p-4 rounded-xl border-2 ${borderClass} ${opacityClass} flex flex-col items-center transition-all duration-300">${isWinner ? '<div class="text-2xl mb-2">üèÜ</div>' : '<div class="h-8 mb-2"></div>'}<h3 class="text-xl font-black text-gray-800 mb-1">${s.text}</h3>${isWinner ? '<span class="bg-yellow-400 text-white text-[10px] font-bold px-2 py-0.5 rounded-full mb-2">WINNER</span>' : ''}${s.isNew ? '<span class="bg-purple-100 text-purple-600 text-xs px-2 py-1 rounded mb-2">New!</span>' : ''}<div class="text-3xl font-bold ${s.score >= 0 ? 'text-green-600' : 'text-red-600'} mb-4">${s.score}</div><div class="w-full space-y-2"><div class="flex justify-between text-xs text-gray-500"><span>Approval</span><span>${s.approval}%</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${s.approval}%"></div></div><div class="flex justify-between text-xs pt-1"><span class="text-green-600 font-bold">+${s.good}</span><span class="text-red-600 font-bold">-${s.bad}</span></div></div></div>`;
                           if(idx === 0) html += `<div class="flex items-center justify-center font-black text-gray-300 md:px-2">VS</div>`;
                       });
                       html += `</div>`;
                   } else {
                       const s = stats[0];
                       html = `<div class="p-4 rounded-xl border border-gray-200 bg-white flex flex-col items-center w-full max-w-xs mx-auto"><h3 class="text-xl font-black text-gray-800 mb-2">${s.text}</h3>${s.isNew ? '<span class="bg-purple-100 text-purple-600 text-xs px-2 py-1 rounded mb-2">Newly Added!</span>' : ''}<div class="text-4xl font-bold ${s.score >= 0 ? 'text-green-600' : 'text-red-600'} mb-4">${s.score}</div><div class="w-full space-y-2"><div class="flex justify-between text-xs text-gray-500"><span>Approval Rating</span><span>${s.approval}%</span></div><div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-blue-500 h-2.5 rounded-full" style="width: ${s.approval}%"></div></div><div class="flex justify-between text-xs pt-1"><span class="text-green-600 font-bold">+${s.good} Votes</span><span class="text-red-600 font-bold">-${s.bad} Votes</span></div></div></div>`;
                   }
                   DOM.inputs.compareResults.innerHTML = html;
                };

                DOM.theme.chooser.onchange = (e) => ThemeManager.apply(e.target.value, true);
                
                document.getElementById('clearAllDataButton').onclick = State.clearAll;

                InputHandler.init();
                ThemeManager.init();
                ModalManager.init();
                await this.refreshData();
            },
            async refreshData(updateDisplay = true) {
                if(updateDisplay) UIManager.showMessage("Loading...");
                const data = await API.fetchWords();
                if(data) {
                    State.runtime.allWords = data.filter(w => (w.notWordVotes||0) < 3);
                    UIManager.updateStats();
                    if(updateDisplay) this.nextWord();
                } else UIManager.showMessage("Connection Error", true);
            },
            nextWord() {
                const pool = State.runtime.allWords;
                if(!pool.length) return;
                
                const rnd = Math.random();
                let sp = null;
                const { CAKE, LLAMA, POTATO, SQUIRREL } = CONFIG.SPECIAL_WORDS;
                const { cake, llama, potato, squirrel } = State.data.badges;
                
                if(!cake && rnd < CAKE.prob) sp = CAKE.text;
                else if(!llama && rnd < CAKE.prob + LLAMA.prob) sp = LLAMA.text;
                else if(!potato && rnd < CAKE.prob + LLAMA.prob + POTATO.prob) sp = POTATO.text;
                else if(!squirrel && rnd < CAKE.prob + LLAMA.prob + POTATO.prob + SQUIRREL.prob) sp = SQUIRREL.text;

                if(sp) {
                    const idx = pool.findIndex(w => w.text.toUpperCase() === sp);
                    if(idx !== -1 && idx !== State.runtime.currentWordIndex) {
                        State.runtime.currentWordIndex = idx;
                        UIManager.displayWord(pool[idx]);
                        return;
                    }
                }

                let candidates = pool.map((w,i) => ({i, votes: (w.goodVotes||0)+(w.badVotes||0)}));
                let available = candidates.filter(c => !State.runtime.history.includes(c.i) && c.i !== State.runtime.currentWordIndex);
                if(!available.length) available = candidates.filter(c => c.i !== State.runtime.currentWordIndex);

                let totalW = 0;
                available = available.map(c => {
                   let weight = 1.0 / (c.votes + 1);
                   if(pool[c.i].text.toUpperCase() === CONFIG.SPECIAL_WORDS.CAKE.text) weight *= CONFIG.BOOST_FACTOR;
                   totalW += weight;
                   return {i: c.i, w: weight};
                });

                let r = Math.random() * totalW;
                let selected = available[available.length-1].i;
                for(let item of available) {
                    r -= item.w;
                    if(r <= 0) { selected = item.i; break; }
                }

                State.runtime.currentWordIndex = selected;
                State.runtime.history.push(selected);
                if(State.runtime.history.length > CONFIG.HISTORY_SIZE) State.runtime.history.shift();
                
                UIManager.displayWord(pool[selected]);
            },
            loadSpecial(text) {
                const idx = State.runtime.allWords.findIndex(w => w.text.toUpperCase() === text);
                if(idx !== -1) { State.runtime.currentWordIndex = idx; UIManager.displayWord(State.runtime.allWords[idx]); }
            },
            async showDefinition() {
                const w = State.runtime.allWords[State.runtime.currentWordIndex];
                if(!w) return;
                ModalManager.toggle('definition', true);
                document.getElementById('definitionWord').textContent = w.text.toUpperCase();
                const resDiv = document.getElementById('definitionResults');
                resDiv.innerHTML = 'Loading...';
                try {
                    const r = await API.define(w.text);
                    if(!r.ok) throw new Error();
                    const d = await r.json();
                    let html = '';
                    d[0].meanings.forEach(m => {
                        html += `<div class="mb-4"><h4 class="text-lg font-bold italic text-indigo-600">${m.partOfSpeech}</h4><ol class="list-decimal list-inside pl-4 mt-2 space-y-1">`;
                        m.definitions.forEach(def => { html += `<li>${def.definition}</li>`; if(def.example) html+=`<p class="text-sm text-gray-500 pl-4 italic">"${def.example}"</p>`; });
                        html += '</ol></div>';
                    });
                    resDiv.innerHTML = html;
                } catch { resDiv.innerHTML = '<p class="text-red-500">Definition not found.</p>'; }
            },
            handleCooldown() {
                State.runtime.isCoolingDown = true;
                let rem = CONFIG.VOTE.COOLDOWN_SEC;
                UIManager.showMessage(`Mashing detected. Wait ${rem}s...`, true);
                State.runtime.cooldownTimer = setInterval(() => {
                    rem--;
                    if(rem>0) UIManager.showMessage(`Wait ${rem}s...`, true);
                    else {
                        clearInterval(State.runtime.cooldownTimer);
                        State.runtime.isCoolingDown = false;
                        State.runtime.streak = 0;
                        UIManager.displayWord(State.runtime.allWords[State.runtime.currentWordIndex]);
                    }
                }, 1000);
            },
            async vote(type, fromSwipe = false) {
                if (State.runtime.isCoolingDown) return;

                const now = Date.now();
                if (State.runtime.lastVoteTime > 0 && (now - State.runtime.lastVoteTime) > CONFIG.VOTE.STREAK_WINDOW) State.runtime.streak = 1;
                else State.runtime.streak++;
                State.runtime.lastVoteTime = now;

                if (State.runtime.streak > CONFIG.VOTE.MASH_LIMIT) { this.handleCooldown(); return; }

                const word = State.runtime.allWords[State.runtime.currentWordIndex];
                const upper = word.text.toUpperCase();
                const { CAKE, LLAMA, POTATO, SQUIRREL } = CONFIG.SPECIAL_WORDS;

                UIManager.disableButtons(true);

                const wd = DOM.game.wordDisplay;
                
                // --- FIXED ANIMATION LOGIC START ---
                if (!fromSwipe && (type === 'good' || type === 'bad')) {
                    this.cleanStyles(wd); // Remove previous styles
                    
                    // RAINBOW FIX: Apply override class to force color visibility
                    wd.style.setProperty('--dynamic-swipe-color', type === 'good' ? '#10b981' : '#ef4444');
                    wd.classList.add('override-theme-color');
                    
                    // 1. Apply Fade Transition
                    wd.classList.add('color-fade');
                    
                    // 2. Set Color (Green/Red) - though override-theme-color will take precedence
                    wd.style.color = type === 'good' ? '#10b981' : '#ef4444';
                    
                    // 3. Wait briefly for color fade, then Fly Out
                    await new Promise(r => setTimeout(r, 50)); // 50ms delay
                    
                    wd.classList.remove('color-fade'); // Remove transition class so fly-out moves freely
                    wd.classList.add(type === 'good' ? 'animate-fly-left' : 'animate-fly-right');
                }
                // --- ANIMATION LOGIC END ---

                const handleSpecial = (conf, badgeKey) => {
                    State.unlockBadge(badgeKey);
                    this.cleanStyles(wd); 
                    wd.className = 'font-extrabold text-gray-900 text-center min-h-[72px]';
                    wd.classList.add(conf.text === 'LLAMA' ? 'word-fade-llama' : 'word-fade-quick');
                    
                    setTimeout(() => {
                        wd.className = ''; wd.style.opacity = '1'; wd.style.transform = 'none';
                        UIManager.showMessage(conf.msg, false);
                        setTimeout(() => { this.nextWord(); this.refreshData(false); }, conf.msgDur);
                    }, conf.fade);
                };

                if (upper === CAKE.text) { handleSpecial(CAKE, 'cake'); return; }
                if (upper === LLAMA.text) { handleSpecial(LLAMA, 'llama'); return; }
                if (upper === POTATO.text) { handleSpecial(POTATO, 'potato'); return; }
                if (upper === SQUIRREL.text) { handleSpecial(SQUIRREL, 'squirrel'); return; }

                try {
                    const themeUnlocked = ThemeManager.checkUnlock(upper);
                    
                    const res = await API.vote(word._id, type);
                    if(res.status === 403) { /* duplicate IP vote, ignore */ }
                    else if(!res.ok) throw new Error();

                    word[`${type}Votes`] = (word[`${type}Votes`]||0) + 1;
                    State.incrementVote();

                    let msg = '';
                    if(themeUnlocked) msg = "üéâ New Theme Unlocked!";
                    else if(State.data.settings.showPercentages && (type==='good'||type==='bad')) {
                        const tot = (word.goodVotes||0)+(word.badVotes||0);
                        const pct = Math.round((word[`${type}Votes`]/tot)*100);
                        msg = `${type==='good'?'Good':'Bad'} vote! ${pct}% agree.`;
                    }
                    if(State.data.settings.showTips) {
                        State.save('voteCounterForTips', State.data.voteCounterForTips + 1);
                        if(State.data.voteCounterForTips % CONFIG.TIP_COOLDOWN === 0) msg = CONFIG.TIPS[Math.floor(Math.random()*CONFIG.TIPS.length)];
                    }

                    UIManager.showPostVoteMessage(msg);
                    UIManager.updateStats();

                    const delay = (type === 'good' || type === 'bad') ? 600 : 0;
                    setTimeout(() => {
                        // CLEANUP: Remove animation classes AND the override class
                        wd.classList.remove('animate-fly-left', 'animate-fly-right', 'swipe-good-color', 'swipe-bad-color', 'override-theme-color');
                        wd.style.transform = ''; 
                        wd.style.opacity = '1';
                        wd.style.color = ''; // Reset color
                        this.nextWord(); 
                        this.refreshData(false);
                    }, delay);

                } catch(e) {
                    console.error(e);
                    UIManager.showMessage("Vote Failed", true);
                    wd.classList.remove('animate-fly-left', 'animate-fly-right', 'swipe-good-color', 'swipe-bad-color', 'override-theme-color');
                    UIManager.disableButtons(false);
                }
            }
        };

        window.onload = Game.init.bind(Game);
    </script>
</body>
</html>

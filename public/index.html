<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOOD WORD / BAD WORD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overscroll-behavior-y: none; /* Helps prevent pull-to-refresh while swiping */
        }
        /* Base styling for all cards */
        .card { 
            backdrop-filter: blur(10px); 
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            position: relative; 
            z-index: 10;
        }
        
        /* Base button styles */
        .good-button { background: linear-gradient(145deg, #10b981, #059669); }
        .bad-button { background: linear-gradient(145deg, #ef4444, #dc2626); }
        .not-word-button { background: linear-gradient(145deg, #64748b, #475569); }
        button { transition: transform 0.1s ease, box-shadow 0.1s ease; }
        button:active { transform: scale(0.98); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
        
        .version-indicator { 
            position: fixed; 
            bottom: 5px; 
            left: 50%; 
            transform: translateX(-50%); 
            font-size: 0.75rem; 
            color: #9ca3af; 
            z-index: 50; 
        }
        
        @media (max-width: 640px) {
            .rank-item { font-size: 0.8rem; }
            .vote-counts { font-size: 0.875rem; }
        }

        /* Animation Classes */
        .word-transition-good {
            animation: slide-out-left-good 0.7s ease-out forwards;
        }
        .word-transition-bad {
            animation: slide-out-right-bad 0.7s ease-out forwards;
        }
        
        /* LLAMA Slow Fade-Out */
        .word-fade-llama {
            transition: opacity 8s ease-out, transform 8s ease-out;
            opacity: 0 !important; 
            transform: scale(0.9) !important;
        }

        /* CAKE/POTATO/SQUIRREL Quick Fade-Out */
        .word-fade-quick {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            opacity: 0 !important; 
            transform: scale(0.95) !important;
        }

        @keyframes slide-out-left-good {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(-150%); opacity: 0; color: #10b981;}
        }
        
        @keyframes slide-out-right-bad {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(150%); opacity: 0; color: #ef4444;}
        }

        #wordDisplay {
            font-size: 6rem;
            white-space: nowrap; 
            overflow: hidden;
            max-width: 100%; 
            box-sizing: border-box;
            position: relative;
            z-index: 10;
            /* Important for drag physics */
            touch-action: none; 
            user-select: none;
        }
        
        /* --- THEME STYLES --- */
        
        /* 0. DEFAULT THEME */
        body.theme-default { 
            background: linear-gradient(135deg, #fef2be 0%, #b5def0 100%) !important; 
        }
        .theme-default #gameCard {
            backdrop-filter: blur(10px); 
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        @keyframes rotate-border {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }
        
        @keyframes rainbow-text {
            0% { -webkit-filter: hue-rotate(0deg); filter: hue-rotate(0deg); }
            100% { -webkit-filter: hue-rotate(360deg); filter: hue-rotate(360deg); }
        }

        /* 1. RAINBOW THEME */
        body.theme-rainbow { background: #f7f7f7 !important; }
        .theme-rainbow .card, .theme-rainbow .ranking-card {
            background-color: transparent; backdrop-filter: none; box-shadow: none; border: none; position: relative; z-index: 10; 
        }
        .theme-rainbow .thin-rainbow-frame {
            position: relative; background-color: #fff; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        /* Updated: Thicker border (inset -6px) */
        .theme-rainbow .thin-rainbow-frame::before {
            content: ''; position: absolute; inset: -6px; border-radius: 1.25rem; 
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #00ffff, #0000ff, #9400d3, #ff0000);
            background-size: 400% 400%; animation: rotate-border 20s linear infinite; z-index: -3; 
        }
        .theme-rainbow .thin-rainbow-frame::after {
            content: ''; position: absolute; inset: -1px; border-radius: 1.1rem; background-color: #ffffff; z-index: -2; 
        }
        /* Updated: Increased padding */
        .theme-rainbow #gameCard { padding: 2.5rem !important; }
        .theme-rainbow .ranking-card { padding: 2rem !important; }

        .theme-rainbow #wordFrame { padding: 0; background-color: transparent; margin-bottom: 1.5rem; }
        .theme-rainbow #wordDisplay {
            background: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #00ffff, #0000ff, #9400d3);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; color: transparent !important; 
            animation: rainbow-text 5s ease infinite; margin-bottom: 0 !important; padding: 0 0.5rem; line-height: 1; 
        }

        /* 2. DARK THEME */
        body.theme-dark { background: #121212 !important; }
        .theme-dark #gameCard {
            background-color: rgba(18, 18, 18, 0.95) !important; box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5) !important; border: none !important; padding: 2rem !important; 
        }
        .theme-dark .card, .theme-dark .ranking-card {
            background-color: rgba(18, 18, 18, 0.95); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5); border: none; 
        }
        .theme-dark header .bg-white { background-color: #374151 !important; color: #d1d5db; }
        .theme-dark header .bg-gray-50 { background-color: #121212 !important; }
        .theme-dark #wordDisplay, .theme-dark .text-gray-900, .theme-dark .rank-item .text-gray-800 { color: #f3f4f6 !important; }
        .theme-dark .text-gray-500, .theme-dark .text-gray-600, .theme-dark .text-gray-800 { color: #9ca3af !important; }
        .theme-dark .border-b { border-color: #4b5563 !important; }

        /* 3. BANANA THEME */
        body.theme-banana { background: #f8f4b2 !important; }
        .theme-banana #wordDisplay { color: #ffd200; animation: bounce-word 0.5s ease-out infinite alternate; }
        @keyframes bounce-word { from { transform: translateY(0); } to { transform: translateY(-15px); } }
        .theme-banana #gameCard {
            background-color: rgba(255, 255, 255, 0.95) !important; border: 2px solid #f4ef81 !important;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15) !important; padding: 2rem !important; 
        }
        
        /* 4. WINTER THEME */
        body.theme-winter { background: linear-gradient(135deg, #e0f7fa 0%, #b3e5fc 100%) !important; }
        .theme-winter #wordDisplay { color: #01579b; text-shadow: 0 0 8px rgba(255, 255, 255, 0.8); }
        .theme-winter #gameCard {
            background-color: rgba(255, 255, 255, 0.9) !important; border: 2px solid #81d4fa !important; 
            box-shadow: 0 15px 40px rgba(179, 229, 252, 0.5) !important; padding: 2rem !important; 
        }
        @keyframes snowfall-1 { 0% { transform: translate3d(0vw, -100vh, 0); } 100% { transform: translate3d(10vw, 100vh, 0); } }
        @keyframes snowfall-2 { 0% { transform: translate3d(0vw, -100vh, 0); } 100% { transform: translate3d(-15vw, 100vh, 0); } }
        .theme-winter #snow-effect {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; overflow: hidden; z-index: 40; pointer-events: none;
        }
        .theme-winter #snow-effect::before, .theme-winter #snow-effect::after {
            content: ''; position: absolute; top: -100vh; left: 0; width: 100%; height: 200%; background-repeat: repeat;
        }
        .theme-winter #snow-effect::before {
            background-image: radial-gradient(4px 4px at 5% 10%, #fff, transparent), radial-gradient(5px 5px at 95% 40%, #fff, transparent);
            background-size: 300px 350px; opacity: 0.6; animation: snowfall-1 50s linear infinite; animation-delay: -5s; 
        }
        .theme-winter #snow-effect::after {
            background-image: radial-gradient(7px 7px at 20% 5%, #fff, transparent), radial-gradient(8px 8px at 70% 35%, #fff, transparent);
            background-size: 500px 600px; opacity: 0.9; animation: snowfall-2 75s linear infinite; animation-delay: -30s; 
        }

        /* 5. SUMMER THEME */
        body.theme-summer { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%) !important; }
        .theme-summer #wordDisplay { color: #FF9800; text-shadow: 0 0 20px #FFF8E1, 0 0 10px #FFEB3B; }
        .theme-summer #gameCard {
            background-color: rgba(255, 255, 255, 0.9) !important; border: 2px solid #FFEB3B !important;
            box-shadow: 0 15px 40px rgba(255, 152, 0, 0.5) !important; padding: 2rem !important; 
        }

        /* 6. HALLOWEEN THEME */
        body.theme-halloween { background: linear-gradient(135deg, #000000 0%, #3a0000 100%) !important; }
        .theme-halloween #wordDisplay { color: #FF8C00; text-shadow: 0 0 20px rgba(255, 140, 0, 1), 0 0 5px rgba(255, 140, 0, 0.5); }
        .theme-halloween .card, .theme-halloween .ranking-card {
            background-color: rgba(10, 0, 0, 0.9) !important; border: 2px solid #FF8C00 !important;
            box-shadow: 0 0 30px rgba(255, 140, 0, 0.5), 0 15px 40px rgba(0, 0, 0, 0.7) !important; 
        }
        .theme-halloween #gameCard { padding: 2rem !important; }
        .theme-halloween .text-gray-900, .theme-halloween .rank-item .text-gray-800 { color: #F3F4F6 !important; }
        .theme-halloween .text-gray-500, .theme-halloween .text-gray-600 { color: #9CA3AF !important; }
        .theme-halloween header .bg-white { background-color: #3A015E !important; color: #d1d5db; }
        .theme-halloween header .bg-gray-50 { background-color: #1C1C1C !important; }
        .theme-halloween h2 { color: #FF8C00 !important; }
        .theme-halloween .border-b { border-color: #691C00 !important; }
        
        /* 7. SUBMARINE THEME */
        @keyframes bobbing-word {
            0% { transform: translateY(0px) rotate(-1deg); }
            50% { transform: translateY(-8px) rotate(1deg); }
            100% { transform: translateY(0px) rotate(-1deg); }
        }
        @keyframes bubble-rise-1 { 0% { transform: translate3d(5vw, 100vh, 0); } 100% { transform: translate3d(20vw, -100vh, 0); } }
        @keyframes bubble-rise-2 { 0% { transform: translate3d(-5vw, 100vh, 0); } 100% { transform: translate3d(-25vw, -100vh, 0); } }

        body.theme-submarine { background: linear-gradient(135deg, #020c1e 0%, #0a1931 50%, #183a5a 100%) !important; }
        .theme-submarine #wordDisplay {
            color: #b0e0e6; text-shadow: 0 0 10px rgba(176, 224, 230, 0.7), 0 0 5px rgba(255, 255, 255, 0.3);
            animation: bobbing-word 2.5s ease-in-out infinite;
        }
        .theme-submarine .card, .theme-submarine .ranking-card {
            background-color: rgba(10, 25, 49, 0.9) !important; border: 2px solid #1c4a7a !important;
            box-shadow: 0 0 20px rgba(28, 74, 122, 0.5), 0 15px 40px rgba(0, 0, 0, 0.7) !important; 
        }
        .theme-submarine #gameCard { padding: 2rem !important; }
        .theme-submarine .text-gray-900, .theme-submarine .rank-item .text-gray-800 { color: #F3F4F6 !important; }
        .theme-submarine .text-gray-500, .theme-submarine .text-gray-600 { color: #9CA3AF !important; }
        .theme-submarine header .bg-white { background-color: #0a1931 !important; color: #d1d5db; }
        .theme-submarine header .bg-gray-50 { background-color: #020c1e !important; }
        .theme-submarine h2 { color: #b0e0e6 !important; }
        .theme-submarine .border-b { border-color: #1c4a7a !important; }
        
        .theme-submarine #bubble-effect {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; overflow: hidden; z-index: 40; pointer-events: none;
        }
        .theme-submarine #bubble-effect::before, .theme-submarine #bubble-effect::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 200%; background-repeat: repeat;
        }
        .theme-submarine #bubble-effect::before {
            background-image: radial-gradient(4px 4px at 5% 10%, rgba(176, 224, 230, 0.4), transparent), radial-gradient(5px 5px at 95% 40%, rgba(176, 224, 230, 0.4), transparent);
            background-size: 300px 350px; opacity: 0.8; animation: bubble-rise-1 50s linear infinite; animation-delay: -5s; 
        }
        .theme-submarine #bubble-effect::after {
             background-image: radial-gradient(7px 7px at 20% 5%, rgba(176, 224, 230, 0.5), transparent), radial-gradient(8px 8px at 70% 35%, rgba(176, 224, 230, 0.5), transparent);
            background-size: 500px 600px; opacity: 0.9; animation: bubble-rise-2 75s linear infinite; animation-delay: -30s; 
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 theme-default">

    <div id="snow-effect" class="fixed inset-0 pointer-events-none hidden"></div> 
    <div id="bubble-effect" class="fixed inset-0 pointer-events-none hidden"></div> 
    
<header class="text-center mb-8 w-full max-w-lg">
    <div id="logoArea" class="h-32 w-full flex items-center justify-center mb-4 relative">
        <div id="leftBadgeContainer" class="absolute left-0 top-1/2 transform -translate-y-1/2 grid grid-cols-2 gap-1 pl-4">
            <div id="cakeBadge" class="p-2 cursor-pointer text-3xl hidden transition duration-300 hover:scale-110" title="The cake is a lie! Click to go back to the word.">üéÇ</div>
            <div id="llamaBadge" class="p-2 cursor-pointer text-3xl hidden transition duration-300 hover:scale-110" title="The Llama has vanished! Click to find the Llama word." >ü¶ô</div>
            <div id="potatoBadge" class="p-2 cursor-pointer text-3xl hidden transition duration-300 hover:scale-110" title="Potatoes gonna potate. Click to find the Potato word.">ü•î</div>
            <div id="squirrelBadge" class="p-2 cursor-pointer text-3xl hidden transition duration-300 hover:scale-110" title="SQUIGGLE! Click to find the Squirrel word.">üêøÔ∏è</div>
        </div>
        <img src="logo.png" alt="Good Word / Bad Word Logo" class="h-full w-auto max-w-full transform translate-x-4">
        <div id="rightBadgeContainer" class="absolute right-0 top-1/2 transform -translate-y-1/2 flex flex-col items-end space-y-1 pr-4">
            <div id="contributorBadge" class="p-2 cursor-pointer text-3xl hidden transition duration-300 hover:scale-110" title="Contributor Badge (0 Submissions)"></div>
            <div id="awardBadge" class="p-2 cursor-pointer text-3xl transition duration-300 hover:scale-110"></div>
        </div>
    </div>
    <div class="mt-4 flex justify-around p-3 rounded-t-xl bg-white shadow-md vote-counts">
        <div id="goodTotal" class="text-xl font-bold text-green-600">GOOD: 0</div>
        <div id="badTotal" class="text-xl font-bold text-red-600">BAD: 0</div>
    </div>
    <div class="flex justify-center p-2 rounded-b-xl bg-gray-50 shadow-md">
        <div id="wordCount" class="text-sm font-semibold text-gray-500">Words in Database: 0</div>
    </div>
</header>

    <main id="gameCard" class="card p-8 w-full max-w-sm flex flex-col items-center rounded-2xl">
        <div id="wordFrame" class="w-full text-center rounded-xl mb-8 relative">
            <div id="wordDisplay" class="font-extrabold text-gray-900 text-center min-h-[72px]">Loading...</div>
        </div>
        <div class="flex space-x-4 w-full mb-3">
            <button id="goodButton" class="good-button flex-1 py-4 text-white text-lg font-bold rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-green-500/50" disabled>Good Word</button>
            <button id="badButton" class="bad-button flex-1 py-4 text-white text-lg font-bold rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-red-500/50" disabled>Bad Word</button>
        </div>
        <button id="notWordButton" class="not-word-button w-full py-3 text-white text-lg font-bold rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-slate-500/50" disabled>Not a word!</button>
        <button id="customWordButton" class="mt-4 text-sm text-gray-600 hover:text-gray-900 transition duration-150">Submit Custom Word</button>
    </main>

    <div id="postVoteMessage" class="mt-4 w-full max-w-sm text-center text-sm font-medium text-gray-600 min-h-[1.5rem] transition-opacity duration-500 opacity-0"></div>
    
    <section class="mt-8 w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="ranking-card card p-6 rounded-xl">
            <h2 class="text-xl font-bold text-green-700 mb-4 border-b pb-2">Top Good Words</h2>
            <div class="ranking-frame thin-rainbow-frame rounded-xl">
                <div id="goodRankings" class="space-y-2"><p class="text-gray-500">No data yet.</p></div>
            </div>
        </div>
        <div class="ranking-card card p-6 rounded-xl">
            <h2 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">Top Bad Words</h2>
            <div class="ranking-frame thin-rainbow-frame rounded-xl">
                <div id="badRankings" class="space-y-2"><p class="text-gray-500">No data yet.</p></div>
            </div>
        </div>
    </section>
    
    <div class="mt-6 w-full max-w-4xl text-center">
        <button id="showTop100Button" class="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-150">Show Top 100 Rankings</button>
        <button id="compareWordsButton" class="mt-4 px-6 py-2 bg-purple-600 text-white font-bold rounded-lg shadow-md hover:bg-purple-700 transition duration-150">Compare Any Two Words</button>
    </div>

    <div class="mt-6 p-4 bg-white/70 rounded-xl w-full max-w-sm flex flex-col items-center shadow-lg border border-gray-100">
        <h3 class="text-lg font-bold text-gray-700 mb-2">Unlocked Themes üé®</h3>
        <select id="themeChooser" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 font-semibold">
            <option value="default">Default</option>
        </select>
        <p id="themeUnlockHint" class="text-xs text-gray-500 mt-2">Vote on special words to unlock new themes!</p>
        <button id="showSettingsButton" class="mt-4 px-4 py-2 w-full bg-slate-200 text-gray-700 font-bold rounded-lg shadow-md hover:bg-slate-300 transition duration-150 text-sm">‚öôÔ∏è Settings</button>
    </div>
    
    <div id="submissionModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl">
            <h2 class="text-2xl font-bold mb-4">Submit a New Word</h2>
            <input type="text" id="newWordInput" placeholder="Enter your word here..." class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-indigo-500">
            <div id="modalMessage" class="text-sm text-red-500 mb-4"></div>
            <div class="flex justify-end space-x-3">
                <button id="cancelSubmitButton" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="submitWordButton" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition">Submit Word</button>
            </div>
        </div>
    </div>
    
    <div id="fullRankingsModalContainer" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="fullRankingsModal" class="bg-white p-6 rounded-xl w-full max-w-6xl max-h-[90vh] shadow-2xl flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold">Top 100 Word Rankings</h2>
                <button id="closeFullRankingsModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold leading-none">&times;</button>
            </div>
            <div class="flex-grow overflow-y-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-green-50/50 p-4 rounded-lg shadow-inner flex flex-col">
                        <h3 class="text-xl font-semibold mb-4 text-green-700">Top 100 Good Words</h3>
                        <div id="fullGoodRankings" class="space-y-1"></div>
                    </div>
                    <div class="bg-red-50/50 p-4 rounded-lg shadow-inner flex flex-col">
                        <h3 class="text-xl font-semibold mb-4 text-red-700">Top 100 Bad Words</h3>
                        <div id="fullBadRankings" class="space-y-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="definitionModalContainer" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="definitionModal" class="bg-white p-6 rounded-xl w-full max-w-lg shadow-2xl flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 id="definitionWord" class="text-2xl font-bold">DEFINITION</h2>
                <button id="closeDefinitionModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold leading-none">&times;</button>
            </div>
            <div id="definitionResults" class="space-y-4 overflow-y-auto"><p>Loading definition...</p></div>
        </div>
    </div>

    <div id="compareModalContainer" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="compareModal" class="bg-white p-6 rounded-xl w-full max-w-lg shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold">Compare Any Two Words</h2>
                <button id="closeCompareModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold leading-none">&times;</button>
            </div>
            <div class="space-y-4">
                <input type="text" id="wordOneInput" placeholder="Enter first word..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                <input type="text" id="wordTwoInput" placeholder="Enter second word..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                <div id="compareResults" class="p-3 bg-gray-50 rounded-lg min-h-[50px]">Type words above to compare them!</div>
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="runComparisonButton" class="px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition">Compare</button>
            </div>
        </div>
    </div>
    
    <div id="settingsModalContainer" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div id="settingsModal" class="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold">User Settings</h2>
                <button id="closeSettingsModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold leading-none">&times;</button>
            </div>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <label for="togglePercentages" class="text-lg font-medium text-gray-700">Show Vote Percentages</label>
                    <input type="checkbox" id="togglePercentages" class="h-6 w-6 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                </div>
                <div class="flex items-center justify-between">
                    <label for="toggleTips" class="text-lg font-medium text-gray-700">Show Tips & Hints</label>
                    <input type="checkbox" id="toggleTips" class="h-6 w-6 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                </div>
            </div>
            <div class="mt-6 border-t pt-4">
                <p class="text-sm text-gray-500">You can also clear all local data (votes, awards, themes, streaks) below. This action is irreversible.</p>
                <button id="clearAllDataButton" class="mt-3 px-4 py-2 w-full bg-red-500 text-white font-medium rounded-lg shadow-md hover:bg-red-600 transition">Clear All Local Data</button>
            </div>
        </div>
    </div>
    
    <div class="version-indicator">v4.4.7 | Made by Gilxs in 12,025</div>

    <script>
        const API_BASE_URL = '/api/words';
        const APP_VERSION = '4.4.7'; 
        
        // Special Words
        const BOOSTED_WORD = 'CAKE'; 
        const LLAMA_WORD = 'LLAMA';
        const POTATO_WORD = 'POTATO';
        const SQUIRREL_WORD = 'SQUIRREL';

        const BOOST_FACTOR = 2.0; 
        
        // Probabilities (must sum up cleanly in logic, each is a slice)
        const CAKE_PROBABILITY = 0.005; 
        const LLAMA_PROBABILITY = 0.005;
        const POTATO_PROBABILITY = 0.005;
        const SQUIRREL_PROBABILITY = 0.005;

        const CONTRIBUTION_THRESHOLD = 5; 
        const CAKE_WORD_FADE_DURATION = 300; 
        const CAKE_MESSAGE_DURATION = 3000; 
        
        const TIPS = [
            "Tip: You can now cast a vote by swiping on mobile devices! Drag the word left for good and right for bad.",
            "Tip: Have you tried comparing words? Use the 'Compare Any Two Words' button!",
            "Tip: Tap the word on the card to see its definition!",
            "Tip: Check out the theme chooser below to unlock new styles.",
            "Tip: You can turn off these messages in the Settings.",
            "Tip: Don't go mistaking your house burning down for the dawn.",
            "Tip: You could go outside for a stomp?",
            "Tip: Nobody else has a clue what's going on either.",
            "Tip: Ask them out for a coffee.",
            "Tip: Can you smell burning toast?",
            "Tip: Your bedroom.",
            "Tip: Play with friends! Not this, something classic like chess or Tetris."
        ];
        const TIP_COOLDOWN = 4; 
        let voteCounterForTips = parseInt(localStorage.getItem('voteCounterForTips')) || 0;
        let messageTimeout = null;

        let allWords = [];
        let currentWordIndex = 0;
        let userId = localStorage.getItem('userId');
        let voteCount = 0; 
        let contributorCount = 0; 
        
        // Badge States
        let cakeBadgeUnlocked = localStorage.getItem('cakeBadgeUnlocked') === 'true';
        let llamaBadgeUnlocked = localStorage.getItem('llamaBadgeUnlocked') === 'true';
        let potatoBadgeUnlocked = localStorage.getItem('potatoBadgeUnlocked') === 'true';
        let squirrelBadgeUnlocked = localStorage.getItem('squirrelBadgeUnlocked') === 'true';
        
        let userSettings = JSON.parse(localStorage.getItem('userSettings')) || {
            showTips: true,
            showPercentages: true
        };

        let voteStreak = 0;
        const MASH_LIMIT = 5;
        const COOLDOWN_SECONDS = 10;
        const STREAK_WINDOW_MS = 1500; 
        let cooldownTimer = null;
        let isCoolingDown = false;
        let lastVoteTime = 0; 
        
        // --- SWIPE TRACKING VARIABLES ---
        let isDragging = false;
        let startX = 0;
        let currentX = 0;
        let initialX = 0;
        let xOffset = 0;
        const SWIPE_THRESHOLD = 100; 
        // --- END SWIPE TRACKING VARIABLES ---

        // --- THEME VARIABLES ---
        let currentTheme = localStorage.getItem('currentTheme') || 'default';
        let unlockedThemes = JSON.parse(localStorage.getItem('unlockedThemes')) || [];
        
        const RAINBOW_STR = 'RAINBOW|GAY|SPARKLE|COLOUR|PRIDE|UNICORN|PROUD|QUEER|GLITTER|LESBIAN|TINSEL';
        const DARK_REVERSED_STR = 'THGINDIM!KCALB!EDAHS!HTOG!WODAHS!AJNIN!KRAD!THGIN!HTLAETS'; 
        const BANANA_STR = 'BANANA|BANANAS|PLANTAIN|YELLOW|SPLIT|MONKEY|HAMMOCK';
        const WINTER_STR = 'SNOWMAN|SNOW|ICE|WINTER|FROZEN|CHILL|COLD|FLAKE|BLIZZARD|ICICLE|SLEIGH|SNOWBALL|SCARF|JACKET|SLEDGE|NOVEMBER|DECEMBER|JANUARY|JINGLE'; 
        const SUMMER_STR = 'SUMMER|HOT|BEACH|HOLIDAY|SUN|VACATION|SWIM|SAND|POOL|JULY|AUGUST|JUNE'; 
        const HALLOWEEN_STR = 'HALLOWEEN|GHOST|PUMPKIN|SPIDER|SWEETS|COSTUME|SPOOKY|OCTOBER|WITCH|VAMPIRE|ZOMBIE|BAT|MONSTER'; 
        const SUBMARINE_STR = 'SUBMARINE|WATER|WAVES|PLYMOUTH|BRIXHAM|PIRATE|SEA|AQUATIC|AQUA|DEEP|OCTOPUS|RUM|SHIP'; 

        const THEME_WORDS = {
            'rainbow': RAINBOW_STR.split('|'),
            'dark': DARK_REVERSED_STR.split('!').map(w => w.split('').reverse().join('')), 
            'banana': BANANA_STR.split('|'),
            'winter': WINTER_STR.split('|'),
            'summer': SUMMER_STR.split('|'),
            'halloween': HALLOWEEN_STR.split('|'),
            'submarine': SUBMARINE_STR.split('|')
        };

        const wordFrame = document.getElementById('wordFrame'); 
        const wordDisplay = document.getElementById('wordDisplay');
        const goodButton = document.getElementById('goodButton');
        const badButton = document.getElementById('badButton');
        const notWordButton = document.getElementById('notWordButton');
        const gameCard = document.getElementById('gameCard'); 
        const goodTotal = document.getElementById('goodTotal');
        const badTotal = document.getElementById('badTotal');
        const wordCount = document.getElementById('wordCount');
        const goodRankingsDiv = document.getElementById('goodRankings');
        const badRankingsDiv = document.getElementById('badRankings');
        const submissionModal = document.getElementById('submissionModal');
        const newWordInput = document.getElementById('newWordInput');
        const modalMessage = document.getElementById('modalMessage');
        const submitWordButton = document.getElementById('submitWordButton');
        const cancelSubmitButton = document.getElementById('cancelSubmitButton');
        const customWordButton = document.getElementById('customWordButton');
        const versionIndicator = document.querySelector('.version-indicator');
        const awardBadge = document.getElementById('awardBadge');
        
        // Badge Elements
        const cakeBadge = document.getElementById('cakeBadge'); 
        const llamaBadge = document.getElementById('llamaBadge'); 
        const potatoBadge = document.getElementById('potatoBadge');
        const squirrelBadge = document.getElementById('squirrelBadge');

        const contributorBadge = document.getElementById('contributorBadge'); 
        const showTop100Button = document.getElementById('showTop100Button');
        const fullRankingsModalContainer = document.getElementById('fullRankingsModalContainer');
        const closeFullRankingsModal = document.getElementById('closeFullRankingsModal');
        const fullGoodRankingsDiv = document.getElementById('fullGoodRankings');
        const fullBadRankingsDiv = document.getElementById('fullBadRankings');
        
        const themeChooser = document.getElementById('themeChooser');
        const themeUnlockHint = document.getElementById('themeUnlockHint');
        const snowEffect = document.getElementById('snow-effect'); 
        const bubbleEffect = document.getElementById('bubble-effect');
        
        const definitionModalContainer = document.getElementById('definitionModalContainer');
        const closeDefinitionModal = document.getElementById('closeDefinitionModal');
        const definitionWord = document.getElementById('definitionWord');
        const definitionResults = document.getElementById('definitionResults');

        const compareWordsButton = document.getElementById('compareWordsButton');
        const compareModalContainer = document.getElementById('compareModalContainer');
        const closeCompareModal = document.getElementById('closeCompareModal');
        const wordOneInput = document.getElementById('wordOneInput');
        const wordTwoInput = document.getElementById('wordTwoInput');
        const compareResults = document.getElementById('compareResults');
        const runComparisonButton = document.getElementById('runComparisonButton');
        
        const postVoteMessage = document.getElementById('postVoteMessage'); 
        const showSettingsButton = document.getElementById('showSettingsButton'); 
        const settingsModalContainer = document.getElementById('settingsModalContainer'); 
        const closeSettingsModal = document.getElementById('closeSettingsModal'); 
        const togglePercentages = document.getElementById('togglePercentages'); 
        const toggleTips = document.getElementById('toggleTips'); 
        const clearAllDataButton = document.getElementById('clearAllDataButton'); 

        function init() {
            if (!userId) {
                userId = crypto.randomUUID();
                localStorage.setItem('userId', userId);
            }
            
            const storedVoteCount = localStorage.getItem('voteCount');
            if (storedVoteCount) {
                voteCount = parseInt(storedVoteCount, 10);
            }
            
            const storedContributorCount = localStorage.getItem('contributorCount');
            if (storedContributorCount) {
                contributorCount = parseInt(storedContributorCount, 10);
            }
            
            versionIndicator.textContent = `v${APP_VERSION} | Made by Gilxs in 12,025`;
            
            goodButton.addEventListener('click', () => submitVote('good'));
            badButton.addEventListener('click', () => submitVote('bad'));
            notWordButton.addEventListener('click', () => submitVote('notWord'));
            customWordButton.addEventListener('click', () => showModal());
            cancelSubmitButton.addEventListener('click', () => hideModal());
            submitWordButton.addEventListener('click', submitCustomWord);
            
            showTop100Button.addEventListener('click', showFullRankingsModal);
            closeFullRankingsModal.addEventListener('click', hideFullRankingsModal);
            fullRankingsModalContainer.addEventListener('click', (e) => {
                if (e.target === fullRankingsModalContainer) {
                    hideFullRankingsModal();
                }
            });
            
            // DRAG & SWIPE EVENT LISTENERS
            gameCard.addEventListener('touchstart', handleTouchStart, false);
            gameCard.addEventListener('touchmove', handleTouchMove, { passive: false }); 
            gameCard.addEventListener('touchend', handleTouchEnd, false);
            
            wordDisplay.addEventListener('click', showDefinitionModal);
            closeDefinitionModal.addEventListener('click', hideDefinitionModal);
            definitionModalContainer.addEventListener('click', (e) => {
                if (e.target === definitionModalContainer) {
                    hideDefinitionModal();
                }
            });

            compareWordsButton.addEventListener('click', showCompareModal);
            closeCompareModal.addEventListener('click', hideCompareModal);
            compareModalContainer.addEventListener('click', (e) => {
                if (e.target === compareModalContainer) {
                    hideCompareModal();
                }
            });
            runComparisonButton.addEventListener('click', runComparison);
            
            showSettingsButton.addEventListener('click', showSettingsModal);
            closeSettingsModal.addEventListener('click', hideSettingsModal);
            settingsModalContainer.addEventListener('click', (e) => {
                if (e.target === settingsModalContainer) {
                    hideSettingsModal();
                }
            });
            togglePercentages.addEventListener('change', updateSettings);
            toggleTips.addEventListener('change', updateSettings);
            clearAllDataButton.addEventListener('click', clearAllLocalData);
            
            // Badge Listeners
            cakeBadge.addEventListener('click', loadCakeWord);
            llamaBadge.addEventListener('click', loadLlamaWord);
            potatoBadge.addEventListener('click', loadPotatoWord);
            squirrelBadge.addEventListener('click', loadSquirrelWord);

            // Stats Badge Listeners (UPDATED)
            awardBadge.addEventListener('click', () => showStatsMessage('award'));
            contributorBadge.addEventListener('click', () => showStatsMessage('contributor'));

            themeChooser.addEventListener('change', (e) => {
                applyTheme(e.target.value);
                if (allWords.length > 0) {
                    displayCurrentWord(allWords[currentWordIndex]);
                }
            });

            fetchWords();
            updateAwardBadge();
            updateContributorBadge(); 
            populateThemeChooser(); 
            applyTheme(currentTheme); 
            updateSpecialBadges(null, true);
            
            window.addEventListener('resize', () => {
                if (allWords.length > 0) {
                    displayCurrentWord(allWords[currentWordIndex]); 
                }
            });
            
            loadSettings();
        }
        
        function loadSettings() {
            togglePercentages.checked = userSettings.showPercentages;
            toggleTips.checked = userSettings.showTips;
        }
        function updateSettings() {
            userSettings.showPercentages = togglePercentages.checked;
            userSettings.showTips = toggleTips.checked;
            localStorage.setItem('userSettings', JSON.stringify(userSettings));
            
            const messageDiv = document.getElementById('postVoteMessage');
            if (messageTimeout) clearTimeout(messageTimeout);
            
            messageDiv.classList.remove('opacity-100');
            messageDiv.classList.add('opacity-0');
            
            setTimeout(() => {
                messageDiv.textContent = 'Settings updated.';
                messageDiv.classList.remove('opacity-0');
                messageDiv.classList.add('opacity-100');
                
                messageTimeout = setTimeout(() => {
                    messageDiv.classList.remove('opacity-100');
                    messageDiv.classList.add('opacity-0');
                }, 2000);
            }, 150);
        }
        function showSettingsModal() {
            loadSettings(); 
            settingsModalContainer.classList.remove('hidden');
            settingsModalContainer.classList.add('flex');
        }
        function hideSettingsModal() {
            settingsModalContainer.classList.remove('flex');
            settingsModalContainer.classList.add('hidden');
        }
        function clearAllLocalData() {
            if (confirm("Are you sure you want to clear ALL your local data (votes, awards, themes, streaks, settings)? This cannot be undone.")) {
                localStorage.clear();
                alert("All local data has been cleared. The application will now reload.");
                window.location.reload();
            }
        }
        
        // --- DRAG & THROW LOGIC ---
        function handleTouchStart(evt) {
            if (isCoolingDown || goodButton.disabled) return; 

            // Stop swipe logic if touching a button or input
            if (evt.target.closest('button') || evt.target.closest('input') || evt.target.closest('select')) return;

            initialX = evt.touches[0].clientX;
            isDragging = true;
            wordDisplay.style.animation = 'none'; 
            wordDisplay.style.transition = 'none'; 
        }

        function handleTouchMove(evt) {
            if (!isDragging) return;
            evt.preventDefault(); 
            currentX = evt.touches[0].clientX;
            xOffset = currentX - initialX;
            const rotation = xOffset * 0.05; 
            wordDisplay.style.transform = `translateX(${xOffset}px) rotate(${rotation}deg)`;
            if (xOffset > 0) {
                wordDisplay.style.color = `rgba(239, 68, 68, ${0.5 + (Math.min(Math.abs(xOffset), 200)/400)})`; 
            } else {
                wordDisplay.style.color = `rgba(16, 185, 129, ${0.5 + (Math.min(Math.abs(xOffset), 200)/400)})`;
            }
        }
        function handleTouchEnd(evt) {
            if (!isDragging) return;
            isDragging = false;
            if (Math.abs(xOffset) > SWIPE_THRESHOLD) {
                const voteType = xOffset > 0 ? 'bad' : 'good';
                const endX = xOffset > 0 ? window.innerWidth : -window.innerWidth;
                wordDisplay.style.transition = 'transform 0.5s ease-out, opacity 0.5s ease-out';
                wordDisplay.style.transform = `translateX(${endX}px) rotate(${xOffset * 0.1}deg)`;
                wordDisplay.style.opacity = '0';
                submitVote(voteType, true);
            } else {
                wordDisplay.style.transition = 'transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.3s'; 
                wordDisplay.style.transform = 'translateX(0px) rotate(0deg)';
                setTimeout(() => {
                     wordDisplay.style.color = ''; 
                     if (currentTheme === 'submarine') {
                         wordDisplay.style.animation = 'bobbing-word 2.5s ease-in-out infinite';
                     } else if (currentTheme === 'banana') {
                         wordDisplay.style.animation = 'bounce-word 0.5s ease-out infinite alternate';
                     } else if (currentTheme === 'rainbow') {
                         wordDisplay.style.animation = 'rainbow-text 5s ease infinite';
                     }
                     displayCurrentWord(allWords[currentWordIndex]);
                }, 300);
            }
            startX = 0; currentX = 0; xOffset = 0;
        }
        
        function findAndLoadSpecialWord(wordText) {
            const specialWord = allWords.find(w => w.text.toUpperCase() === wordText);
            if (specialWord) {
                const newIndex = allWords.findIndex(w => w.text.toUpperCase() === wordText);
                if (newIndex !== -1) currentWordIndex = newIndex;
                displayCurrentWord(specialWord);
                const messageDiv = document.getElementById('postVoteMessage');
                messageDiv.classList.add('opacity-0');
            } else {
                 showMessage(`The word '${wordText}' is not currently in the database.`, true);
            }
        }
        
        function loadCakeWord() { findAndLoadSpecialWord(BOOSTED_WORD); }
        function loadLlamaWord() { findAndLoadSpecialWord(LLAMA_WORD); }
        function loadPotatoWord() { findAndLoadSpecialWord(POTATO_WORD); }
        function loadSquirrelWord() { findAndLoadSpecialWord(SQUIRREL_WORD); }

        function updateSpecialBadges(votedWordText = null, init = false) {
            if (votedWordText) {
                const upperWord = votedWordText.toUpperCase();
                if (upperWord === BOOSTED_WORD) {
                    cakeBadgeUnlocked = true;
                    localStorage.setItem('cakeBadgeUnlocked', 'true');
                }
                if (upperWord === LLAMA_WORD) {
                    llamaBadgeUnlocked = true;
                    localStorage.setItem('llamaBadgeUnlocked', 'true');
                }
                if (upperWord === POTATO_WORD) {
                    potatoBadgeUnlocked = true;
                    localStorage.setItem('potatoBadgeUnlocked', 'true');
                }
                if (upperWord === SQUIRREL_WORD) {
                    squirrelBadgeUnlocked = true;
                    localStorage.setItem('squirrelBadgeUnlocked', 'true');
                }
            }
            
            // Cake
            if (cakeBadgeUnlocked) {
                cakeBadge.classList.remove('hidden');
                cakeBadge.classList.add('cursor-pointer');
            } else if (init) {
                cakeBadge.classList.add('hidden', 'cursor-pointer'); 
            }
            
            // Llama
            if (llamaBadgeUnlocked) {
                llamaBadge.classList.remove('hidden');
                llamaBadge.classList.add('cursor-pointer');
            } else if (init) {
                llamaBadge.classList.add('hidden'); 
                llamaBadge.classList.remove('cursor-pointer');
            }

            // Potato
            if (potatoBadgeUnlocked) {
                potatoBadge.classList.remove('hidden');
                potatoBadge.classList.add('cursor-pointer');
            } else if (init) {
                potatoBadge.classList.add('hidden', 'cursor-pointer'); 
            }

            // Squirrel
            if (squirrelBadgeUnlocked) {
                squirrelBadge.classList.remove('hidden');
                squirrelBadge.classList.add('cursor-pointer');
            } else if (init) {
                squirrelBadge.classList.add('hidden', 'cursor-pointer'); 
            }
        }

        function populateThemeChooser() {
            themeChooser.innerHTML = '<option value="default">Default</option>'; 
            const availableThemes = [...new Set(unlockedThemes)].sort();
            const allThemeKeys = Object.keys(THEME_WORDS);
            for (const key of allThemeKeys) {
                if (unlockedThemes.includes(key) && !availableThemes.includes(key)) {
                    availableThemes.push(key);
                }
            }
            availableThemes.sort();

            availableThemes.forEach(themeKey => {
                const themeName = themeKey.charAt(0).toUpperCase() + themeKey.slice(1);
                const option = document.createElement('option');
                option.value = themeKey;
                option.textContent = themeName;
                themeChooser.appendChild(option);
            });
            themeChooser.value = currentTheme;
            if (availableThemes.length > 0) {
                themeUnlockHint.textContent = `You have ${availableThemes.length} themes unlocked!`;
            } else {
                themeUnlockHint.textContent = `Vote on special words to unlock new themes!`;
            }
        }

        function applyTheme(theme) {
            document.body.className = document.body.className.split(' ').filter(c => !c.startsWith('theme-')).join(' ');
            const themeToApply = theme === 'default' ? 'default' : theme;
            document.body.classList.add(`theme-${themeToApply}`);
            currentTheme = theme;
            localStorage.setItem('currentTheme', currentTheme);
            
            if (snowEffect) snowEffect.classList.toggle('hidden', theme !== 'winter');
            if (bubbleEffect) bubbleEffect.classList.toggle('hidden', theme !== 'submarine');

            if (theme === 'rainbow') {
                gameCard.classList.add('thin-rainbow-frame', 'p-6');
                gameCard.classList.remove('card', 'p-8');
            } else {
                gameCard.classList.remove('thin-rainbow-frame', 'p-6');
                gameCard.classList.add('card', 'p-8');
            }
        }

        function checkAndApplyTheme(wordText) {
            const upperWord = wordText.toUpperCase();
            let newThemeToUnlock = null;
            let themeWasNewlyUnlocked = false;

            for (const [themeKey, triggerWords] of Object.entries(THEME_WORDS)) {
                if (triggerWords.includes(upperWord)) {
                    newThemeToUnlock = themeKey;
                    break;
                }
            }
            
            if (newThemeToUnlock) {
                if (!unlockedThemes.includes(newThemeToUnlock)) {
                    unlockedThemes.push(newThemeToUnlock);
                    localStorage.setItem('unlockedThemes', JSON.stringify(unlockedThemes));
                    themeWasNewlyUnlocked = true;
                    applyTheme(newThemeToUnlock);
                    populateThemeChooser();
                    return true;
                } else if (currentTheme !== newThemeToUnlock) {
                    applyTheme(newThemeToUnlock);
                    populateThemeChooser();
                }
            }
            return themeWasNewlyUnlocked;
        }

        function updateAwardBadge() {
            let star = '', title = '';
            if (voteCount >= 250) { star = 'üèÜ'; title = `Platinum Star Award!`; } 
            else if (voteCount >= 50) { star = 'üåü'; title = `Gold Star Award!`; } 
            else if (voteCount >= 25) { star = 'ü•à'; title = `Silver Star Award!`; } 
            else if (voteCount >= 5) { star = 'ü•â'; title = `Bronze Star Award!`; } 
            else { star = 'üò∂'; title = `Next Award: Bronze (5 Votes)`; }
            
            awardBadge.textContent = star;
            // Combined stats string
            awardBadge.title = `${title} (Total Votes: ${voteCount} | Submitted: ${contributorCount})`;
        }
        
        function updateContributorBadge() {
            if (contributorCount >= CONTRIBUTION_THRESHOLD) {
                contributorBadge.textContent = '‚úçÔ∏è';
                // Combined stats string
                contributorBadge.title = `Contributor Badge Unlocked! (Total Votes: ${voteCount} | Submitted: ${contributorCount})`;
                contributorBadge.classList.remove('hidden');
            } else {
                contributorBadge.textContent = '';
                contributorBadge.classList.add('hidden');
            }
        }

        function showAwardMessageAndContinue(awardName, emoji) {
            wordDisplay.textContent = `${emoji} ${awardName} Unlocked! ${emoji}`;
            wordDisplay.style.fontSize = '2.25rem'; 
            wordDisplay.style.color = '#10b981';
            wordDisplay.style.cursor = 'default'; 
            wordDisplay.className = 'text-4xl font-extrabold text-green-700 text-center min-h-[72px] animate-pulse';
            wordFrame.style.padding = '0';
            wordFrame.style.backgroundColor = 'transparent';
            goodButton.disabled = true;
            badButton.disabled = true;
            notWordButton.disabled = true;
            
            document.getElementById('postVoteMessage').classList.add('opacity-0');
            
            setTimeout(() => {
                wordDisplay.classList.remove('animate-pulse');
                nextWord(); 
                fetchWords(false);
            }, 2500);
        }

        function showMessage(text, isError = false) {
            wordDisplay.textContent = text;
            wordDisplay.className = `text-4xl font-bold text-center min-h-[72px] ${isError ? 'text-red-500' : 'text-gray-500'}`;
            wordDisplay.style.fontSize = '1.0rem'; 
            wordDisplay.style.cursor = 'default'; 
            wordFrame.style.padding = '0';
            wordFrame.style.backgroundColor = 'transparent';
            goodButton.disabled = true;
            badButton.disabled = true;
            notWordButton.disabled = true;
        }
        
        function showCooldownMessage(remainingSeconds) {
            wordDisplay.textContent = `Button mashing will not be tolerated. Wait ${remainingSeconds}s...`;
            wordDisplay.className = 'text-4xl font-bold text-red-600 text-center min-h-[72px]';
            wordDisplay.style.fontSize = '1.5rem'; 
            wordDisplay.style.cursor = 'default'; 
            wordFrame.style.padding = '0';
            wordFrame.style.backgroundColor = 'transparent';
            goodButton.disabled = true;
            badButton.disabled = true;
            notWordButton.disabled = true;
        }

        // NEW FUNCTION: Displays stats in the message area on click
        function showStatsMessage(type) {
            const messageDiv = document.getElementById('postVoteMessage');
            if (messageTimeout) clearTimeout(messageTimeout);

            let msg = '';
            if (type === 'award') {
                let title = 'No Award Yet';
                if (voteCount >= 250) title = 'Platinum Star Award';
                else if (voteCount >= 50) title = 'Gold Star Award';
                else if (voteCount >= 25) title = 'Silver Star Award';
                else if (voteCount >= 5) title = 'Bronze Star Award';
                
                msg = `üèÜ ${title}<br>Total Votes: ${voteCount} | Submitted: ${contributorCount}`;
            } else {
                msg = `‚úçÔ∏è Contributor Stats<br>Total Votes: ${voteCount} | Submitted: ${contributorCount}`;
            }

            messageDiv.classList.remove('opacity-100');
            messageDiv.classList.add('opacity-0');

            setTimeout(() => {
                messageDiv.innerHTML = msg;
                messageDiv.classList.remove('opacity-0');
                messageDiv.classList.add('opacity-100');

                messageTimeout = setTimeout(() => {
                    messageDiv.classList.remove('opacity-100');
                    messageDiv.classList.add('opacity-0');
                }, 3000);
            }, 150);
        }
        
        function displayPostVoteMessage(word, voteType, themeUnlocked, awardAchieved) {
            const messageDiv = document.getElementById('postVoteMessage');
            if (messageTimeout) clearTimeout(messageTimeout);

            let messageContent = '';
            const isGoodOrBad = voteType === 'good' || voteType === 'bad';
            
            // Determine which message should show (Mutual Exclusion Logic)
            if (themeUnlocked) {
                messageContent = `üéâ New theme unlocked! Check the theme chooser.`;
            } else if (awardAchieved) {
                messageContent = `üåü New award unlocked! Check the badge area.`;
            } else if (isGoodOrBad) {
                // Check if tip should be shown first
                let showTip = false;
                if (userSettings.showTips) {
                    voteCounterForTips++;
                    localStorage.setItem('voteCounterForTips', voteCounterForTips);
                    if (voteCounterForTips % TIP_COOLDOWN === 0) {
                        showTip = true;
                    }
                }

                if (showTip) {
                     const tipIndex = Math.floor(Math.random() * TIPS.length);
                     messageContent = TIPS[tipIndex];
                } else if (userSettings.showPercentages) {
                    // Show stats only if tip isn't showing
                    const totalVotes = (word.goodVotes || 0) + (word.badVotes || 0);
                    if (totalVotes > 0) {
                        const sameVotes = voteType === 'good' ? (word.goodVotes || 0) : (word.badVotes || 0);
                        const percentage = Math.round((sameVotes / totalVotes) * 100);
                        const voteText = voteType === 'good' ? 'Good' : 'Bad';
                        messageContent = `${voteText} vote registered! ${percentage}% of people also voted '${voteText}'. (${sameVotes}/${totalVotes})`;
                    }
                }
            }

            if (!messageContent) return; 

            messageDiv.classList.remove('opacity-100');
            messageDiv.classList.add('opacity-0');

            setTimeout(() => {
                messageDiv.innerHTML = messageContent;
                messageDiv.classList.remove('opacity-0');
                messageDiv.classList.add('opacity-100');

                messageTimeout = setTimeout(() => {
                    messageDiv.classList.remove('opacity-100');
                    messageDiv.classList.add('opacity-0');
                }, 5000); 
            }, 150);
        }

        function displayCurrentWord(currentWord) {
            if (!currentWord) { showMessage("No words available! Try submitting one.", false); return; }
            const wordText = currentWord.text.toUpperCase();
            
            wordDisplay.classList.remove('word-transition-good', 'word-transition-bad', 'word-fade-llama', 'word-fade-cake', 'word-fade-quick'); 
            wordDisplay.textContent = wordText;
            wordDisplay.className = 'font-extrabold text-gray-900 text-center min-h-[72px]';
            
            wordDisplay.style.background = ''; wordDisplay.style.webkitBackgroundClip = ''; wordDisplay.style.webkitTextFillColor = '';
            wordDisplay.style.color = '#111827'; wordDisplay.style.animation = ''; wordDisplay.style.transform = '';
            wordDisplay.style.textShadow = ''; wordDisplay.style.opacity = '1'; wordDisplay.style.cursor = 'default'; 
            wordDisplay.style.removeProperty('animation'); 
            wordFrame.style.padding = '0'; wordFrame.style.backgroundColor = 'transparent';
            
            if (currentTheme === 'dark' || currentTheme === 'halloween' || currentTheme === 'submarine') { 
                wordDisplay.style.color = '#f3f4f6'; 
                if (currentTheme === 'halloween') {
                    wordDisplay.style.color = '#FF8C00'; 
                    wordDisplay.style.textShadow = '0 0 20px rgba(255, 140, 0, 1), 0 0 5px rgba(255, 140, 0, 0.5)';
                }
                if (currentTheme === 'submarine') { 
                    wordDisplay.style.color = '#b0e0e6';
                    wordDisplay.style.textShadow = '0 0 10px rgba(176, 224, 230, 0.7), 0 0 5px rgba(255, 255, 255, 0.3)';
                    wordDisplay.style.transform = 'translateY(0)'; 
                    wordDisplay.style.animation = 'bobbing-word 2.5s ease-in-out infinite';
                }
            } else if (currentTheme === 'banana') {
                wordDisplay.style.transform = 'translateY(0)';
                wordDisplay.style.animation = 'bounce-word 0.5s ease-out infinite alternate';
                wordDisplay.style.color = '#ffd200';
            } else if (currentTheme === 'winter') {
                wordDisplay.style.color = '#01579b'; 
                wordDisplay.style.textShadow = '0 0 8px rgba(255, 255, 255, 0.8)';
            } else if (currentTheme === 'summer') {
                wordDisplay.style.color = '#FF9800'; 
                wordDisplay.style.textShadow = '0 0 20px #FFF8E1, 0 0 10px #FFEB3B'; 
            } else if (currentTheme === 'rainbow') {
                wordDisplay.style.background = 'linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #00ffff, #0000ff, #9400d3)';
                wordDisplay.style.webkitBackgroundClip = 'text'; 
                wordDisplay.style.webkitTextFillColor = 'transparent';
                wordDisplay.style.color = 'transparent';
                wordDisplay.style.animation = 'rainbow-text 5s ease infinite';
            }

            const maxFontSize = 96; 
            const cardElement = document.getElementById('gameCard');
            const cardComputedStyle = window.getComputedStyle(cardElement);
            const cardPaddingHorizontal = parseFloat(cardComputedStyle.paddingLeft) + parseFloat(cardComputedStyle.paddingRight);
            const cardContentWidth = cardElement.clientWidth - cardPaddingHorizontal; 
            
            let wordDisplayPaddingHorizontal = 0;
            let maxAvailableWidthForTextContent = cardContentWidth;

            if (currentTheme === 'rainbow') {
                wordDisplay.style.padding = '0 0.5rem';
                wordDisplayPaddingHorizontal = parseFloat(window.getComputedStyle(wordDisplay).paddingLeft) * 2;
                maxAvailableWidthForTextContent = cardContentWidth - wordDisplayPaddingHorizontal;
            } else {
                wordDisplay.style.padding = '0 1rem'; 
                wordDisplayPaddingHorizontal = parseFloat(window.getComputedStyle(wordDisplay).paddingLeft) * 2;
                maxAvailableWidthForTextContent = cardContentWidth - wordDisplayPaddingHorizontal;
            }

            wordDisplay.style.fontSize = `${maxFontSize}px`;
            wordDisplay.style.whiteSpace = 'nowrap'; 
            
            let currentTextWidth = wordDisplay.scrollWidth;
            let finalFontSize = maxFontSize;

            if (currentTextWidth > maxAvailableWidthForTextContent) { 
                const scaleFactor = maxAvailableWidthForTextContent / currentTextWidth;
                finalFontSize = Math.floor(maxFontSize * scaleFactor);
                if (finalFontSize < 24) finalFontSize = 24; 
            }
            
            wordDisplay.style.fontSize = `${finalFontSize}px`;
            wordDisplay.style.whiteSpace = 'normal'; 
            
            if (!isCoolingDown && !currentWord.isSpecialMessage) {
                wordDisplay.style.cursor = 'grab'; 
                goodButton.disabled = false;
                badButton.disabled = false;
                notWordButton.disabled = false;
            }
        }

        function getWeightedRandomWordIndex(excludeIndex = -1) { 
            if (allWords.length === 0) return -1;
            const random = Math.random();
            let specialWordText = null, specialWordIndex = -1;

            if (!cakeBadgeUnlocked && random < CAKE_PROBABILITY) { 
                specialWordText = BOOSTED_WORD; 
            } else if (!llamaBadgeUnlocked && random >= CAKE_PROBABILITY && random < (CAKE_PROBABILITY + LLAMA_PROBABILITY)) { 
                specialWordText = LLAMA_WORD; 
            } else if (!potatoBadgeUnlocked && random >= (CAKE_PROBABILITY + LLAMA_PROBABILITY) && random < (CAKE_PROBABILITY + LLAMA_PROBABILITY + POTATO_PROBABILITY)) {
                specialWordText = POTATO_WORD;
            } else if (!squirrelBadgeUnlocked && random >= (CAKE_PROBABILITY + LLAMA_PROBABILITY + POTATO_PROBABILITY) && random < (CAKE_PROBABILITY + LLAMA_PROBABILITY + POTATO_PROBABILITY + SQUIRREL_PROBABILITY)) {
                specialWordText = SQUIRREL_WORD;
            }

            if (specialWordText) {
                specialWordIndex = allWords.findIndex(w => w.text.toUpperCase() === specialWordText);
                if (specialWordIndex !== -1 && specialWordIndex !== excludeIndex) return specialWordIndex;
            }
            
            if (allWords.length === 1) return 0;

            const availableWords = allWords.map((w, index) => ({
                index, totalVotes: (w.goodVotes || 0) + (w.badVotes || 0) + (w.notWordVotes || 0)
            })).filter(w => w.index !== excludeIndex);
            
            const wordPool = availableWords.length > 0 ? availableWords : allWords.map((w, index) => ({ index, totalVotes: (w.goodVotes || 0) + (w.badVotes || 0) + (w.notWordVotes || 0) }));
            let totalWeight = 0;
            const weightedWords = wordPool.map(w => {
                let weight = 1.0 / (w.totalVotes + 1);
                if (allWords[w.index].text.toUpperCase() === BOOSTED_WORD) weight *= BOOST_FACTOR;
                totalWeight += weight;
                return { index: w.index, weight: weight };
            });

            let randomNum = Math.random() * totalWeight;
            for (const word of weightedWords) {
                randomNum -= word.weight;
                if (randomNum <= 0) return word.index;
            }
            return wordPool[wordPool.length - 1].index;
        }

        function nextWord() {
            if (allWords.length === 0) return;
            currentWordIndex = getWeightedRandomWordIndex(currentWordIndex);
            displayCurrentWord(allWords[currentWordIndex]);
        }

        async function fetchWords(updateDisplay = true) {
            try {
                if(updateDisplay) showMessage("Loading words...", false);
                const response = await fetch(API_BASE_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                let fetchedWords = await response.json();
                const availableWords = fetchedWords.filter(w => (w.notWordVotes || 0) < 3);
                allWords = availableWords;
                wordCount.textContent = `Words in Database: ${fetchedWords.length}`;
                if (allWords.length > 0) {
                    updateStatsAndRankings();
                    if (updateDisplay) {
                        currentWordIndex = getWeightedRandomWordIndex(-1);
                        displayCurrentWord(allWords[currentWordIndex]);
                    } 
                } else {
                    showMessage("No words available! Try submitting one.", false);
                }
            } catch (error) {
                console.error('Error fetching words:', error);
                if(updateDisplay) showMessage("Connection Error. Check API.", true);
            }
        }

        async function submitVote(voteType, fromSwipe = false) {
            if (isCoolingDown) {
                const remaining = Math.ceil((cooldownEndTime - Date.now()) / 1000);
                showCooldownMessage(remaining > 0 ? remaining : 0);
                return;
            }

            const now = Date.now();
            if (lastVoteTime > 0 && (now - lastVoteTime) > STREAK_WINDOW_MS) voteStreak = 1; 
            else voteStreak++; 
            lastVoteTime = now; 

            if (voteStreak > MASH_LIMIT) {
                isCoolingDown = true;
                voteStreak = 0; 
                let remaining = COOLDOWN_SECONDS;
                const cooldownEndTime = Date.now() + COOLDOWN_SECONDS * 1000;
                showCooldownMessage(remaining);
                cooldownTimer = setInterval(() => {
                    remaining--;
                    if (remaining > 0) showCooldownMessage(remaining);
                    else {
                        clearInterval(cooldownTimer);
                        cooldownTimer = null;
                        isCoolingDown = false;
                        if (allWords.length > 0) displayCurrentWord(allWords[currentWordIndex]);
                        else fetchWords(); 
                    }
                }, 1000);
                return;
            }

            const currentWord = allWords[currentWordIndex];
            if (!currentWord) return;

            const isCake = currentWord.text.toUpperCase() === BOOSTED_WORD; 
            const isLlama = currentWord.text.toUpperCase() === LLAMA_WORD;
            const isPotato = currentWord.text.toUpperCase() === POTATO_WORD;
            const isSquirrel = currentWord.text.toUpperCase() === SQUIRREL_WORD;
            
            goodButton.disabled = true;
            badButton.disabled = true;
            notWordButton.disabled = true;

            const wordId = currentWord._id;
            const transitionDuration = 700; 
            
            if (voteType === 'good' || voteType === 'bad') {
                if (isCake || isLlama || isPotato || isSquirrel) { /* handled below */ } 
                else if (!fromSwipe) {
                    const animationName = voteType === 'good' ? 'slide-out-left-good' : 'slide-out-right-bad';
                    wordDisplay.style.animation = `${animationName} ${transitionDuration / 1000}s ease-out forwards`;
                }
            }
            
            if (isCake) {
                wordDisplay.classList.add('word-fade-cake'); 
                updateSpecialBadges(currentWord.text);
                setTimeout(() => {
                    wordDisplay.classList.remove('word-fade-cake'); 
                    wordDisplay.style.opacity = '1'; wordDisplay.style.transform = 'none'; 
                    showMessage("The cake is a lie!", false); 
                    wordDisplay.style.fontSize = '1.5rem'; 
                    setTimeout(() => { nextWord(); fetchWords(false); }, CAKE_MESSAGE_DURATION); 
                }, CAKE_WORD_FADE_DURATION); 
                return; 
            }

            if (isLlama) {
                wordDisplay.classList.add('word-fade-llama'); 
                updateSpecialBadges(currentWord.text);
                setTimeout(() => {
                    wordDisplay.classList.remove('word-fade-llama'); 
                    wordDisplay.style.opacity = '1'; wordDisplay.style.transform = 'none'; 
                    showMessage("what llama?", false); 
                    wordDisplay.style.fontSize = '1rem'; 
                    setTimeout(() => { nextWord(); fetchWords(false); }, 2000); 
                }, 8000);
                return; 
            }

            if (isPotato) {
                wordDisplay.classList.add('word-fade-quick'); 
                updateSpecialBadges(currentWord.text);
                setTimeout(() => {
                    wordDisplay.classList.remove('word-fade-quick'); 
                    wordDisplay.style.opacity = '1'; wordDisplay.style.transform = 'none'; 
                    showMessage("Potatoes gonna potate.", false); 
                    wordDisplay.style.fontSize = '1.5rem'; 
                    setTimeout(() => { nextWord(); fetchWords(false); }, 2000); 
                }, 300); 
                return; 
            }

            if (isSquirrel) {
                wordDisplay.classList.add('word-fade-quick'); 
                updateSpecialBadges(currentWord.text);
                setTimeout(() => {
                    wordDisplay.classList.remove('word-fade-quick'); 
                    wordDisplay.style.opacity = '1'; wordDisplay.style.transform = 'none'; 
                    showMessage("SQUIRREL!", false); 
                    wordDisplay.style.fontSize = '3rem'; 
                    setTimeout(() => { nextWord(); fetchWords(false); }, 1500); 
                }, 300); 
                return; 
            }

            const themeWasNewlyUnlocked = checkAndApplyTheme(currentWord.text);
            updateSpecialBadges(currentWord.text); 

            let updatedWordData = currentWord;
            let awardAchieved = false;

            try {
                const response = await fetch(`/api/words/${wordId}/vote`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voteType, userId })
                });

                const result = await response.json();

                if (response.status === 403) {
                    voteStreak = 0; 
                    const totalDelay = ((voteType === 'good' || voteType === 'bad') ? transitionDuration : 0);
                    displayPostVoteMessage(currentWord, voteType, themeWasNewlyUnlocked, false); 
                    setTimeout(() => { nextWord(); fetchWords(false); }, totalDelay); 
                } else if (!response.ok) {
                    throw new Error(result.message || "Failed to register vote.");
                } else {
                    const updatedWordResponse = await fetch(`${API_BASE_URL}/${wordId}`);
                    if (updatedWordResponse.ok) {
                        updatedWordData = await updatedWordResponse.json();
                        Object.assign(currentWord, updatedWordData);
                    } else {
                         currentWord[`${voteType}Votes`] = (currentWord[`${voteType}Votes`] || 0) + 1;
                         updatedWordData = currentWord;
                    }

                    const previousVoteCount = voteCount; 
                    voteCount++;
                    localStorage.setItem('voteCount', voteCount);
                    updateAwardBadge();
                    
                    let awardName = '', emoji = '';
                    if (previousVoteCount < 5 && voteCount >= 5) { awardName = 'Bronze Star'; emoji = 'ü•â'; awardAchieved = true; }
                    else if (previousVoteCount < 25 && voteCount >= 25) { awardName = 'Silver Star'; emoji = 'ü•à'; awardAchieved = true; }
                    else if (previousVoteCount < 50 && voteCount >= 50) { awardName = 'Gold Star'; emoji = 'üåü'; awardAchieved = true; }
                    else if (previousVoteCount < 250 && voteCount >= 250) { awardName = 'Platinum Star'; emoji = 'üèÜ'; awardAchieved = true; }

                    displayPostVoteMessage(updatedWordData, voteType, themeWasNewlyUnlocked, awardAchieved);

                    if (themeWasNewlyUnlocked || awardAchieved) {
                        const messageToDisplay = themeWasNewlyUnlocked 
                            ? `'${currentTheme.charAt(0).toUpperCase() + currentTheme.slice(1)}' Theme`
                            : awardName;
                        const emojiToDisplay = themeWasNewlyUnlocked ? 'üéÅ' : emoji;
                        showAwardMessageAndContinue(messageToDisplay, emojiToDisplay);
                    } else {
                        const transitionDelay = (voteType === 'good' || voteType === 'bad') ? transitionDuration : 0;
                        setTimeout(() => { nextWord(); fetchWords(false); }, transitionDelay);
                    }
                }
            } catch (error) {
                console.error('Error submitting vote:', error);
                showMessage("Vote failed. Try again.", true);
                wordDisplay.classList.remove('word-transition-good', 'word-transition-bad', 'word-fade-cake', 'word-fade-quick'); 
                goodButton.disabled = false; badButton.disabled = false; notWordButton.disabled = false;
                voteStreak = 0; 
            }
        }

        function getRankedWords(limit) {
            const allWordsFetched = JSON.parse(JSON.stringify(allWords));
            const rankedWords = allWordsFetched.map(w => ({
                text: w.text, good: w.goodVotes || 0, bad: w.badVotes || 0, score: (w.goodVotes || 0) - (w.badVotes || 0)
            }));
            const topGood = [...rankedWords].sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return (b.good + b.bad) - (a.good + a.bad);
            }).slice(0, limit);
            const topBad = [...rankedWords].sort((a, b) => {
                if (a.score !== b.score) return a.score - b.score;
                return (b.good + b.bad) - (a.good + a.bad);
            }).slice(0, limit);
            return { topGood, topBad };
        }

        function updateStatsAndRankings() {
            if (allWords.length === 0) return;
            const totalGood = allWords.reduce((sum, w) => sum + (w.goodVotes || 0), 0);
            const totalBad = allWords.reduce((sum, w) => sum + (w.badVotes || 0), 0);
            goodTotal.textContent = `GOOD: ${totalGood}`;
            badTotal.textContent = `BAD: ${totalBad}`;
            const { topGood, topBad } = getRankedWords(5);
            renderRankings(goodRankingsDiv, topGood, 'good');
            renderRankings(badRankingsDiv, topBad, 'bad');
        }

        function renderRankings(container, list, type, isFullList = false) {
            container.innerHTML = '';
            if (list.length === 0) {
                container.innerHTML = `<p class="text-gray-500">${type === 'good' ? 'No clear winners yet.' : 'No clear losers yet.'}</p>`;
                return;
            }
            list.forEach((word, index) => {
                const item = document.createElement('div');
                item.className = `flex justify-between items-center py-1 ${isFullList ? 'full-ranking-item text-sm' : 'rank-item'}`;
                const scoreIndicator = type === 'good' 
                    ? `<span class="text-xs text-white bg-green-500 px-2 rounded-full font-bold">${word.score}</span>`
                    : `<span class="text-xs text-white bg-red-500 px-2 rounded-full font-bold">${Math.abs(word.score)}</span>`;
                item.innerHTML = `
                    <div class="flex items-center ${isFullList ? 'space-x-3' : 'space-x-2'}">
                        <span class="font-bold ${isFullList ? 'text-base w-8' : 'text-lg w-5'} text-center text-gray-500 flex-shrink-0">${index + 1}.</span>
                        <span class="font-medium text-gray-800">${word.text.toUpperCase()}</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        ${scoreIndicator}
                        <span class="text-sm text-gray-600">(${word.good} / ${word.bad})</span>
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        function showFullRankingsModal() {
            const { topGood, topBad } = getRankedWords(100);
            renderRankings(fullGoodRankingsDiv, topGood, 'good', true);
            renderRankings(fullBadRankingsDiv, topBad, 'bad', true);
            fullRankingsModalContainer.classList.remove('hidden');
            fullRankingsModalContainer.classList.add('flex');
        }

        function hideFullRankingsModal() {
            fullRankingsModalContainer.classList.remove('flex');
            fullRankingsModalContainer.classList.add('hidden');
        }

        function showModal() {
            submissionModal.classList.remove('hidden');
            submissionModal.classList.add('flex');
            newWordInput.value = '';
            modalMessage.textContent = '';
        }

        function hideModal() {
            submissionModal.classList.remove('flex');
            submissionModal.classList.add('hidden');
        }

        async function submitCustomWord() {
            const text = newWordInput.value.trim();
            if (!text) { modalMessage.textContent = "Please enter a word."; return; }
            if (text.length > 45) { modalMessage.textContent = "Word must be 45 characters or less."; return; }
            if (text.includes(' ')) { modalMessage.textContent = "Please enter a single word (no spaces)."; return; }

            submitWordButton.disabled = true;
            modalMessage.textContent = "Submitting...";

            try {
                const response = await fetch(API_BASE_URL, { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text })
                });
                const result = await response.json();
                if (response.status === 201) {
                    modalMessage.textContent = "Success! Word added to the pool.";
                    contributorCount++;
                    localStorage.setItem('contributorCount', contributorCount);
                    updateContributorBadge();
                    setTimeout(() => { hideModal(); fetchWords(); }, 1000);
                } else {
                    modalMessage.textContent = result.message || "Failed to submit word due to an unknown error.";
                }
            } catch (error) {
                console.error('Error submitting custom word:', error);
                modalMessage.textContent = "A network error occurred.";
            } finally {
                submitWordButton.disabled = false;
            }
        }
        
        function showCompareModal() {
            compareModalContainer.classList.remove('hidden'); compareModalContainer.classList.add('flex');
            wordOneInput.value = ''; wordTwoInput.value = ''; compareResults.innerHTML = 'Type words above to compare them!';
        }
        function hideCompareModal() { compareModalContainer.classList.remove('flex'); compareModalContainer.classList.add('hidden'); }
        
        function findWordInLocalDB(text) { return allWords.find(w => w.text.toUpperCase() === text.toUpperCase()); }

        async function checkAndSubmitWord(text) {
            const wordData = findWordInLocalDB(text);
            const upperText = text.toUpperCase();
            if (wordData) {
                return { text: upperText, status: 'exists', good: wordData.goodVotes || 0, bad: wordData.badVotes || 0 };
            } else {
                try {
                    const response = await fetch(API_BASE_URL, { 
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: text })
                    });
                    if (response.status === 201) {
                        contributorCount++; localStorage.setItem('contributorCount', contributorCount); updateContributorBadge();
                        return { text: upperText, status: 'newlyAdded' };
                    } else if (response.status === 409) {
                         const fetchSingle = await fetch(`${API_BASE_URL}/${text}`);
                         const fetchedData = await fetchSingle.json();
                         if (fetchSingle.ok) {
                            allWords.push(fetchedData); 
                            return { text: upperText, status: 'exists', good: fetchedData.goodVotes || 0, bad: fetchedData.badVotes || 0 };
                         }
                         return { text: upperText, status: 'error', message: 'Word exists but could not retrieve data.' };
                    } else {
                        const result = await response.json(); throw new Error(result.message || 'Failed to submit word.');
                    }
                } catch (error) {
                    return { text: upperText, status: 'error', message: `Submission failed: ${error.message}` };
                }
            }
        }

        async function runComparison() {
            const wordOneText = wordOneInput.value.trim();
            const wordTwoText = wordTwoInput.value.trim();
            if (!wordOneText && !wordTwoText) {
                compareResults.innerHTML = '<span class="text-red-500">Please enter at least one word to compare.</span>'; return;
            }
            runComparisonButton.disabled = true; compareResults.innerHTML = 'Analyzing words...';
            const results = [];
            if (wordOneText) results.push(await checkAndSubmitWord(wordOneText));
            if (wordTwoText) {
                if (!wordOneText || wordOneText.toUpperCase() !== wordTwoText.toUpperCase()) results.push(await checkAndSubmitWord(wordTwoText));
                else if (wordOneText && results.length === 1) results.push({...results[0], status: 'duplicate'});
            }
            let outputHtml = '';
            for (const [index, result] of results.entries()) {
                const word = `<strong>${result.text}</strong>`;
                const isWordOne = index === 0;
                if (result.status === 'exists') {
                    outputHtml += `
                        <div class="${isWordOne ? 'border-b pb-2 mb-2' : ''}">
                        <p class="mb-2">Word ${index + 1} (${word}) exists in the database:</p>
                        <ul class="list-disc list-inside ml-4 mb-3 text-sm">
                            <li>Good Votes: <span class="text-green-600 font-bold">${result.good}</span></li>
                            <li>Bad Votes: <span class="text-red-600 font-bold">${result.bad}</span></li>
                            <li>Score (Good - Bad): <span class="font-bold">${result.good - result.bad}</span></li>
                        </ul>
                        </div>`;
                } else if (result.status === 'newlyAdded') {
                    outputHtml += `<p class="mb-3 text-purple-600 ${isWordOne ? 'border-b pb-2' : ''}">Word ${index + 1} (${word}) was **not found** and has been **added** to the database! (0 Good, 0 Bad votes).</p>`;
                } else if (result.status === 'error') {
                     outputHtml += `<p class="mb-3 text-red-500 ${isWordOne ? 'border-b pb-2' : ''}">Word ${index + 1} (${word}) status could not be determined: ${result.message}</p>`;
                } else if (result.status === 'duplicate') {
                    outputHtml += `<p class="mb-3 text-gray-500">Word 2 is a duplicate of Word 1 (${word}). Showing the same stats.</p>`;
                }
            }
            if (results.some(r => r.status === 'newlyAdded')) fetchWords(false); 
            compareResults.innerHTML = outputHtml || '<span class="text-red-500">No valid words were entered.</span>';
            runComparisonButton.disabled = false;
        }

        async function showDefinitionModal() {
            if (isCoolingDown || !allWords[currentWordIndex] || goodButton.disabled) return; 
            const currentWord = allWords[currentWordIndex];
            const wordText = currentWord.text.toLowerCase();
            definitionModalContainer.classList.remove('hidden'); definitionModalContainer.classList.add('flex');
            definitionWord.textContent = currentWord.text.toUpperCase();
            definitionResults.innerHTML = '<p>Loading definition...</p>';
            try {
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${wordText}`);
                if (!response.ok) {
                    if (response.status === 404) definitionResults.innerHTML = '<p class="text-red-500">Sorry, no definition was found for this word.</p>';
                    else throw new Error(`API error! status: ${response.status}`);
                } else {
                    const data = await response.json();
                    definitionResults.innerHTML = formatDefinitionHtml(data);
                }
            } catch (error) {
                console.error('Error fetching definition:', error);
                definitionResults.innerHTML = '<p class="text-red-500">An error occurred while fetching the definition.</p>';
            }
        }

        function hideDefinitionModal() { definitionModalContainer.classList.remove('flex'); definitionModalContainer.classList.add('hidden'); }

        function formatDefinitionHtml(data) {
            if (!data || data.length === 0) return '<p class="text-red-500">Sorry, no definition was found.</p>';
            let html = '';
            const wordData = data[0]; 
            wordData.meanings.forEach(meaning => {
                html += `<div class="mb-4"><h4 class="text-lg font-bold italic text-indigo-600">${meaning.partOfSpeech}</h4>`;
                html += '<ol class="list-decimal list-inside pl-4 mt-2 space-y-1">';
                meaning.definitions.forEach(def => {
                    html += `<li>${def.definition}</li>`;
                    if (def.example) html += `<p class="text-sm text-gray-500 pl-4 italic">"${def.example}"</p>`;
                });
                html += '</ol></div>';
            });
            return html;
        }
        
        window.loadCakeWord = loadCakeWord;
        window.loadLlamaWord = loadLlamaWord;
        window.applyTheme = applyTheme; 
        window.onload = init;
    </script>
</body>
</html>
